<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>èŠç™‚è²“ Bar Â· AI è²“åº—é•· 16bit</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
  --kk-radius-lg: 18px;
  --kk-radius-md: 12px;
  --kk-radius-sm: 8px;

  --kk-surface-main: #f4ede4;      /* æ•´é«”èƒŒæ™¯ */
  --kk-surface-card: #fff9f0;      /* å¡ç‰‡åº•è‰² */
  --kk-shadow-strong: 0 18px 40px rgba(0,0,0,0.15);
  --kk-shadow-soft:   0 8px 20px rgba(0,0,0,0.10);

  --kk-accent:       #c48a3a;      /* ä¸»è‰²ï¼šå¸¶ä¸€é»é‡‘çš„æ·ºå’–å•¡ */
  --kk-primary-soft: #f7e0b8;
  --kk-line-soft:    rgba(180,140,90,0.35);

  --kk-text-main:    #3b2922;      /* æ·±å’–å•¡å­— */
  --kk-text-sub:     #7a6054;
}

body {
  min-height: 100vh;
  display: flex;
  align-items: flex-start;  /* å¾ç½®ä¸­æ”¹æˆé ä¸Š */
  justify-content: center;
  padding-top: 20px;       /* æƒ³å†é«˜ä¸€é»ï¼Œå°±æ¸›å°‘é€™å€‹æ•¸å­— */
  background: #f4ede4;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  color: var(--kk-text-main);
}



/* æ‰‹æ©Ÿ 100vh ç©ºç™½ä¿®æ­£ */
@supports (height: 100dvh) {
  body {
    min-height: 100dvh;
  }
}

/* å°è¢å¹•å†é †ä¾¿æ‹¿æ‰å¤šé¤˜çš„ä¸Šå…§è·ï¼Œè®“ç•«é¢æ›´è²¼è¿‘æ»¿ç‰ˆ */
@media (max-width: 480px) {
  body {
    padding-top: 0;
    align-items: center;
  }
}

.reco-cards {
  margin-top: 6px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.reco-card {
  border-radius: 8px;
  border: 1px solid #555;
  background: #222;
  padding: 6px 8px;
  font-size: 12px;
}

.reco-card-title {
  font-weight: 600;
  margin-bottom: 2px;
}

.reco-card-meta {
  font-size: 11px;
  color: #bbb;
  margin-bottom: 2px;
}

.reco-card-note {
  font-size: 11px;
  color: #ddd;
}

/* æ®¼æ›´åƒä¸€å°ä¸»æ©Ÿ */
/* æ®¼æœ¬èº«æ”¹æˆæ·ºè‰²å¡ç‰‡æ„Ÿ */
.game-shell {
  width: 100%;
  max-width: 380px;
  background: var(--kk-surface-card);
  border-radius: var(--kk-radius-lg);
  border: 1px solid rgba(255,255,255,0.7);
  box-shadow: var(--kk-shadow-strong);
  padding: 16px 16px 18px;
}

/* å°è©±æ¡†ï¼šäº®åº•ï¼‹æ·±å­—ï¼Œè¨˜å¾—ä¿ç•™ .visible åˆ‡æ› */
.dialog-box {
  width: min(340px, 100% - 20px);
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid var(--kk-line-soft);
  background: linear-gradient(to bottom, #fffdf8, #fbead2);
  box-shadow: 0 10px 24px rgba(0,0,0,0.18);
  font-size: 13px;
  line-height: 1.7;
  color: var(--kk-text-main);
  max-height: 220px;
  overflow-y: auto;

  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 6px;
  z-index: 4;

  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s;
}

.dialog-box.visible {
  opacity: 1;
  pointer-events: auto;
}



.dialog-label {
  font-size: 11px;
  color: var(--kk-accent);
  letter-spacing: 0.16em;
  text-transform: uppercase;
  margin-bottom: 4px;
  opacity: 0.9;
}

.dialog-text {
  white-space: pre-line;
  max-width: 310px;
  margin: 2px auto 0;
  color: var(--kk-text-main);
  text-align: left;
}



.title-bar {
  text-align: center;
  font-size: 15px;
  line-height: 1.5;
  margin-bottom: 6px;
  color: var(--kk-text-main);
}
.title-bar span {
  font-weight: 700;
}
.title-bar small {
  font-size: 11px;
  color: var(--kk-text-sub);
}

/* ç‹€æ…‹åˆ— chipï¼šæ¢å¾©è† å›Šæ„Ÿã€åŠ å°æ¯” */
.status-bar {
  display: flex;
  justify-content: center;
  gap: 6px;
  font-size: 11px;
  margin-bottom: 8px;
}
.status-bar span {
  padding: 3px 10px;
  border-radius: 999px;
  background: #fff7eb;
  border: 1px solid var(--kk-line-soft);
  color: var(--kk-text-sub);
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}


/* ===== èµ·å§‹ç•«é¢ï¼šè§’è‰²é¸æ“‡ ===== */
.screen {
  flex: 1;
  position: relative;
  display: none;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
}
.screen.active { display: flex; }

#screen-select { padding-top: 6px; }
.select-top {
  margin-bottom: 6px;
  text-align: center;
  font-size: 14px;
  line-height: 1.6;
}
.select-sub {
  margin-bottom: 12px;
  text-align: center;
  font-size: 11px;
  line-height: 1.6;
  color: var(--kk-text-sub);  /* æ·±ä¸€é» */
}

.char-grid {
  display: flex;
  justify-content: space-around;
  width: 100%;
  max-width: 320px;
  margin-bottom: 14px;
}
.char-card {
  width: 90px;
  padding: 8px;
  background: #fffaf2;                     /* äº®åº• */
  border-radius: 12px;
  border: 1px solid var(--kk-line-soft);
  text-align: center;
  cursor: pointer;
  transition: 0.16s;
  box-shadow: 0 4px 10px rgba(0,0,0,0.10);
}

.char-card:hover {
  border-color: var(--kk-accent);
  transform: translateY(-2px);
}

.char-card.active {
  border-color: var(--kk-accent);
  box-shadow:
    0 0 0 1px rgba(196,138,58,0.35),
    0 4px 12px rgba(0,0,0,0.20);
  background: #ffeecd;
}


.char-role-name {
  font-size: 12px;
  margin-top: 2px;
}

.char-role-note {
  font-size: 10px;
  color: var(--kk-text-sub);  /* æ¯”ç¾åœ¨æ·±ä¸€éš */
  margin-top: 3px;
  line-height: 1.4;
}

/* é è¦½è§’è‰²ï¼šé«˜åº¦ 64 */
.char-sprite {
  height: 64px;
  margin: 0 auto 6px;
  background-repeat: no-repeat;
  background-size: auto 64px;
  background-position: bottom center;
  image-rendering: pixelated;
}
.char-sprite-img{
  display: block;
  height: 64px;
  margin: 0 auto 6px;
  image-rendering: pixelated;
}
.char-sprite-img.boy{
  width: 44px;
}
.char-sprite.boy  { width: 25px; background-image:url("assets/hero-boy-front.png"); }
.char-sprite.girl { width: 28px; background-image:url("assets/hero-girl-front.png"); }
.char-sprite.cat  { width: 39px; background-image:url("assets/hero-cat-front.png"); }

.nick-row {
  width: 100%;
  max-width: 320px;
  margin-bottom: 4px;
}
.nick-row label {
  font-size: 12px;
  display: block;
  margin-bottom: 4px;
}
.nick-row input {
  width: 100%;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,0.15);
  background: #fffaf2;             /* æ·ºåº• */
  color: var(--kk-text-main);      /* æ·±å­— */
  font-size: 13px;
  outline: none;
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.8);
}

.nick-row input::placeholder {
  color: var(--kk-text-sub);
}

.nick-row input:focus {
  border-color: var(--kk-accent);
  box-shadow:
    0 0 0 1px rgba(196,138,58,0.35),
    0 0 0 4px rgba(196,138,58,0.12);
}
.btn-primary {
  margin-top: 10px;
  width: 100%;
  max-width: 320px;
  padding: 10px 14px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.8);
  background:
    radial-gradient(circle at 10% 0%, rgba(255,255,255,0.9), transparent 55%),
    linear-gradient(135deg, #ffcf6b, #ff9f3f);
  color: #3b2515;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow:
    0 8px 18px rgba(0,0,0,0.22),
    0 0 0 1px rgba(255,255,255,0.5);
  backdrop-filter: blur(14px);   /* æ¶²æ…‹ç»ç’ƒé—œéµ */
  -webkit-backdrop-filter: blur(14px);
  transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
}

.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow:
    0 10px 22px rgba(0,0,0,0.26),
    0 0 0 1px rgba(255,255,255,0.7);
  filter: brightness(1.03);
}

.btn-primary:active {
  transform: translateY(0);
  box-shadow:
    0 4px 10px rgba(0,0,0,0.25);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}


.small-hint {
  font-size: 11px;
   color: var(--kk-text-sub);
  margin-top: 6px;
  text-align: center;
}

/* ===== éŠæˆ²ç•«é¢ï¼šç›´å¼ 360x440 + å°è©±æ¡† ===== */
#screen-game {
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding-top: 0;
}

.pixel-screen {
  width: min(360px, 100%);
  aspect-ratio: 9 / 11;           /* å–ä»£å›ºå®š height */
  border-radius: 12px;
  background: #000;
  overflow: hidden;
  position: relative;
  margin: 0 auto 6px;
}

/* èƒŒæ™¯ base å±¤ */
.scene-base {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  image-rendering: pixelated;
  z-index: 1;
  opacity: 0;
  transition: opacity 0.4s;
}
.scene-base.active { opacity: 1; }

/* å‰æ™¯ fg å±¤ */
.scene-fg {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  image-rendering: pixelated;
  z-index: 3;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.4s;
}
.scene-fg.active { opacity: 1; }

/* 360x480 base/fg PNG */
.scene--outside-base { background-image: url("assets/bg-outside-base.png"); }
.scene--outside-fg   { background-image: url("assets/bg-outside-fg.png"); }
.scene--inside-base  { background-image: url("assets/bg-inside-base.png"); }
.scene--inside-fg    { background-image: url("assets/bg-inside-fg.png"); }

/* ===== ä¸»è§’ ===== */
.hero {
  position: absolute;
  top: 360px;
  left: 260px;
  height: 64px;
  background-repeat: no-repeat;
  background-size: auto 64px;
  image-rendering: pixelated;
  transform: scale(2);
  transform-origin: bottom center;
  z-index: 2;
}

.hero--boy-front      { width: 25px; background-image: url("assets/hero-boy-front.png"); }
.hero--boy-back-idle  { width: 25px; background-image: url("assets/hero-boy-back-idle.png"); }
.hero--boy-back-walk  { width: 25px; background-image: url("assets/hero-boy-back-walk.png"); }

.hero--girl-front     { width: 28px; background-image: url("assets/hero-girl-front.png"); }
.hero--girl-back-idle { width: 28px; background-image: url("assets/hero-girl-back-idle.png"); }
.hero--girl-back-walk { width: 28px; background-image: url("assets/hero-girl-back-walk.png"); }

.hero--cat-front      { width: 39px; background-image: url("assets/hero-cat-front.png"); }
.hero--cat-back-idle  { width: 39px; background-image: url("assets/hero-cat-back-idle.png"); }
.hero--cat-back-walk  { width: 39px; background-image: url("assets/hero-cat-back-walk.png"); }

/* ===== AIè²“åº—é•· ===== */
.cat-clerk {
  position: absolute;
  top: 165px;
  left: 300px;
  height: 32px;
  background-repeat: no-repeat;
  background-size: auto 32px;
  image-rendering: pixelated;
  transform: scale(2);
  transform-origin: bottom center;
  opacity: 0;
  transition: opacity 0.4s;
  z-index: 1;
}
.cat-clerk.visible { opacity: 1; }
.cat-clerk-idle {
  width: 30px;
  background-image: url("assets/cat-clerk-idle.png");
}
/* æ‰‹æ”¾ä¸‹ï¼šå®¢äººç«™åˆ°é¢å‰é–‹å§‹å°è©±æ™‚ç”¨ */
.cat-clerk-talk {
  width: 30px;
  background-image: url("assets/cat-clerk-talk.png");
}

/* ===== å°è©±æ¡† ===== */
.dialog-box {
  width: min(340px, 100% - 20px);
  padding: 10px 14px;
  border-radius: 12px;
  border: 1px solid var(--kk-line-soft);
  background:
    linear-gradient(to bottom, rgba(255,255,255,0.96), rgba(249,239,227,0.96));
  box-shadow: 0 10px 24px rgba(153,120,90,0.4);
  font-size: 13px;
  line-height: 1.7;
  color: var(--kk-text-main);
  max-height: 220px;
  overflow-y: auto;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 6px;
  z-index: 4;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s;
}

.dialog-label {
  font-size: 11px;
  color: var(--kk-accent);
  letter-spacing: 0.18em;
  text-transform: uppercase;
  margin-bottom: 4px;
  opacity: 0.9;
}


.dialog-choices {
  margin-top: 12px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: flex-start;
}

.dialog-btn {
  border-radius: 999px;
  border: 1px solid var(--kk-line-soft);
  background: #fff7eb;
  color: var(--kk-text-main);
  font-size: 12px;
  padding: 6px 12px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.10);
  transition: background 0.16s, transform 0.08s, box-shadow 0.16s, border-color 0.16s;
}

.dialog-btn:hover {
  background: #ffeecd;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* å¡ç‰‡å‹é¸é …ï¼ˆå¿ƒæƒ… / ç›®çš„ / åå¥½ï¼‰ */
.dialog-btn.mood-card-btn,
.dialog-btn.goal-btn,
.dialog-btn.pref-card-btn {
  width: 100%;
  justify-content: flex-start;
  gap: 10px;
  padding: 8px 10px;
  margin-bottom: 6px;
  border-radius: 10px;
  background: #fffaf2;
}

/* å·²é¸ï¼šä½  JS è£¡æœƒåŠ  active-goal */
.dialog-btn.active-goal {
  background: #f7e0b8;
  border-color: var(--kk-accent);
  box-shadow:
    0 0 0 1px rgba(196,138,58,0.45),
    0 4px 10px rgba(0,0,0,0.25);
  color: #3b2515;
}



/* é€šç”¨å¡ç‰‡å‹é¸é … */
.choice-card {
  width: 100%;
  justify-content: flex-start;
  padding: 8px 10px;
  margin-bottom: 6px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(0, 0, 0, 0.40);
}

.choice-card:hover {
  background: rgba(255,255,255,0.07);
  color: var(--kk-text-main);
}

.choice-card.active-goal {
  border-color: var(--kk-accent);
  background: rgba(242,201,160,0.22);
}

/* æ–‡å­—çµæ§‹ */
.choice-emoji { font-size: 18px; flex-shrink: 0; }
.choice-text  { display:flex; flex-direction:column; align-items:flex-start; line-height:1.4; }
.choice-title { font-size: 13px; color: var(--kk-text-main); }
.choice-sub   { font-size: 11px; color: var(--kk-text-sub); margin-top:2px; }

/* å•ã€Œä»Šå¤©ä¸€å®šè¦æœ‰ä»€éº¼ã€ç”¨çš„å¡ç‰‡å¼é¸é … */
.dialog-btn.goal-btn {
  width: 100%;
  justify-content: flex-start;
  gap: 10px;
  padding: 8px 10px;
  margin-bottom: 6px;
}

/* å¿ƒæƒ…ï¼†èº«é«”æ„Ÿå—ç”¨å¡ç‰‡é¸é … */
.dialog-btn.pref-card-btn {
  width: 100%;
  justify-content: flex-start;
  gap: 10px;
  padding: 8px 10px;
  margin-bottom: 6px;
  border-radius: 10px;
  background: #fffaf2;
  border-color: rgba(180,140,90,0.35);
  white-space: normal;
  text-align: left;
}

.dialog-btn.mood-card-btn:hover,
.dialog-btn.goal-btn:hover,
.dialog-btn.pref-card-btn:hover {
  background: #fff2de;
}

.mood-emoji {
  font-size: 18px;
  flex-shrink: 0;
}

.mood-text {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  line-height: 1.4;
}

.mood-title {
  font-size: 13px;
  color: var(--kk-text-main);
}

.mood-sub {
  margin-top: 2px;
  font-size: 11px;
  color: var(--kk-text-sub);
}

.dialog-btn.goal-btn.active-goal {
  background: rgba(210, 170, 120, 0.35);
  border-color: var(--kk-primary-soft);
}

.goal-emoji {
  font-size: 18px;
  flex-shrink: 0;
}

.goal-text {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  line-height: 1.4;
}

.goal-title {
  font-size: 13px;
  color: var(--kk-text-main);
}

.goal-sub {
  margin-top: 2px;
  font-size: 11px;
  color: var(--kk-text-sub);
}

.dialog-btn:hover {
  background: rgba(249,243,239,0.10);
  color: var(--kk-text-main);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.6);
}

.dialog-btn:active {
  transform: translateY(0);
  box-shadow: 0 1px 3px rgba(0,0,0,0.5);
}

/* è¢«é¸å–çš„é¸é … */
.dialog-btn.active-goal {
  background: #f3dfc2;
  border-color: var(--kk-accent);
  box-shadow: 0 0 0 1px rgba(201,152,100,0.35),
              0 4px 10px rgba(150,120,90,0.45);
  color: #3b2515;
}


/* ã€Œä¸»è¦è¡Œå‹•ã€æŒ‰éˆ•ï¼Œå¯åœ¨ JS åŠ é€™å€‹ class */
.dialog-btn-primary {
  background: var(--kk-primary-soft);
  border-color: var(--kk-primary-soft);
  color: #3b2515;
}

/* èº«é«”éœ€æ±‚ï¼é£²é£Ÿé™åˆ¶ç”¨çš„å¡ç‰‡é¸é … */
.dialog-btn.pref-card-btn {
  width: 100%;
  justify-content: flex-start;
  gap: 10px;
  padding: 8px 10px;
  margin-bottom: 6px;
  background: rgba(0, 0, 0, 0.35);
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  white-space: normal;
  text-align: left;
}

.dialog-btn.pref-card-btn.active-goal {
  background: rgba(210, 170, 120, 0.35);
  border-color: var(--kk-primary-soft);
}

.pref-emoji {
  font-size: 18px;
  flex-shrink: 0;
}

.pref-text {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  line-height: 1.4;
}

.pref-title {
  font-size: 13px;
  color: var(--kk-text-main);
}

.pref-sub {
  margin-top: 2px;
  font-size: 11px;
  color: var(--kk-text-sub);
}

/* çµæœé¢æ¿ä¸Šæ–¹çš„ loading é®ç½© */
.result-loading {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(3px);   /* èƒŒæ™¯å¾®å¾®æ¨¡ç³Š */
  z-index: 20;                  /* æ¯” result-panel æœ¬èº«æ›´ä¸Šå±¤ */
}

.result-loading.hidden {
  display: none;
}

.result-loading-card {
  background: rgba(255, 253, 249, 0.96);   /* äº®åº• */
  border-radius: 10px;
  border: 1px solid rgba(180,140,90,0.35);
  box-shadow: 0 12px 28px rgba(0,0,0,0.18);
  padding: 10px 12px;
  max-width: 320px;
  font-size: 12px;
  line-height: 1.7;
  display: flex;
  gap: 8px;
  align-items: center;   /* æ”¹æˆç½®ä¸­å°é½Šè²“ï¼‹æ–‡å­— */
}
.result-loading-text{
  color: var(--kk-text-main);
}
/* æ”¾ä¸‰å¼µæ€è€ƒä¸­çš„è²“åº—é•· */
.result-loading-cats {
  position: relative;
  width: 64px;      /* ä¾ç…§ä½ åœ–çš„å¤§å°å¾®èª¿ */
  height: 64px;
  flex-shrink: 0;
}

.result-loading-cats img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  image-rendering: pixelated;        /* å¦‚æœæ˜¯åƒç´ é¢¨å¯ä»¥ä¿ç•™ */
  opacity: 0;
  animation: cat-thinking 1.8s infinite;
}

/* ä¸‰å¼µåœ–è¼ªæµå‡ºç¾ï¼š0s / 0.6s / 1.2s */
.result-loading-cats img:nth-child(1) {
  animation-delay: 0s;
}
.result-loading-cats img:nth-child(2) {
  animation-delay: 0.6s;
}
.result-loading-cats img:nth-child(3) {
  animation-delay: 1.2s;
}

@keyframes cat-thinking {
  0%   { opacity: 0; }
  10%  { opacity: 1; }
  33%  { opacity: 1; }
  43%  { opacity: 0; }
  100% { opacity: 0; }
}

.result-loading-text {
  color: var(--kk-text-main);
}.result-loading-icon {
  font-size: 20px;
  animation: paw-bounce 0.8s infinite alternate;
}

.result-loading-text {
  color: var(--kk-text-main);
}
/* æ–‡å­—æœ€å¾Œä¸‰å€‹é»çš„é€²åº¦å‹•ç•«ï¼š. â†’ .. â†’ ... å¾ªç’° */
.loading-dots::after {
  content: "";
  display: inline-block;
  width: 1.2em;          /* é ç•™ä¸‰å€‹å­—å…ƒçš„å¯¬åº¦ */
  text-align: left;
  animation: dots-step 1s steps(3, end) infinite;
}
@keyframes dots-step {
  0%   { content: "";   }
  33%  { content: ".";  }
  66%  { content: ".."; }
  100% { content: "...";}
}


/* ç°¡å–®çš„å°è·³å‹•å‹•ç•« */
@keyframes paw-bounce {
  from { transform: translateY(0); }
  to   { transform: translateY(-3px); }
}

/* æ•´é«”èƒŒæ™¯ï¼šæ”¹æˆèŠç™‚è²“ç³»çš„æº«æš–ç±³ç™½è‰²ç³» */
body {
  background: #F9F5F0;
}

.pixel-screen {
  background: #FFF8EF;
  border: 2px solid #E2D4C4;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
}

/* ===== æŒ‰éˆ•æ¨£å¼é‡æ–°å®šç¾©ï¼ˆfor ä½ éŠæˆ²ç•«é¢è£¡çš„æ‰€æœ‰æŒ‰éˆ•ï¼‰===== */
.pixel-screen button {
  background: #FFFFFF;
  color: #5A4030;              /* æ·±å’–å•¡å­—è‰²ï¼Œæ¸…æ¥šå¥½è®€ */
  border: 1px solid #D8C6B4;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 13px;
  cursor: pointer;
  box-shadow: 0 2px 0 rgba(0, 0, 0, 0.08);
  transition: background 0.15s, transform 0.1s, box-shadow 0.1s, color 0.15s;
}

/* hoverï¼šæ¯”åŸæœ¬ç•¥æ·±ä¸€é»ï¼Œçœ‹å¾—å‡ºæœ‰åæ‡‰ï¼Œä½†é‚„æ˜¯æ˜äº® */
.pixel-screen button:hover {
  background: #F2E3D3;
}

/* æŒ‰ä½ / é»ä¸‹é‚£ä¸€ç¬é–“ï¼šè¼•å¾®ä¸‹å£“ï¼Œä¸åç™½ã€ä¸æ”¹æˆæ€ªé¡è‰² */
.pixel-screen button:active {
  background: #E7D3C0;
  transform: translateY(1px);
  box-shadow: 0 0 0 rgba(0, 0, 0, 0.0);
  color: #5A4030;   /* é‡é»ï¼šç¶­æŒæ·±è‰²å­—ï¼Œä¸è¦è®Šæ·¡è‰²æˆ–ç™½è‰² */
}

/* å¦‚æœä½ æœ‰ã€Œè¢«é¸å–ä¸­çš„æŒ‰éˆ•ã€classï¼ˆä¾‹å¦‚ .selected / .activeï¼‰ï¼Œé †ä¾¿ä¸€èµ·è™•ç† */
.pixel-screen button.selected,
.pixel-screen button.active,
.pixel-screen button[aria-pressed="true"] {
  background: #E0C7A8;
  border-color: #C49A72;
  color: #4A3528;
}
/* ===== èŠç™‚è²“äº®è‰²ç³»è¦†è“‹è¨­å®šï¼ˆè²¼åœ¨ style çš„æœ€ä¸‹é¢ï¼‰ ===== */

/* æ•´é«”èƒŒæ™¯ï¼šå¥¶èŒ¶è‰²ï¼Œä¸è¦æ­»ç™½ */
body {
  background: #F8F1E8;
}

/* æŠŠ Tailwind çš„ bg-black æ›æˆäº®è‰²å¡ç‰‡ */
.bg-black {
  background-color: #FFF8EF !important;
}

/* æŠŠ text-white æ›æˆæ·±å’–å•¡å­—è‰² */
.text-white {
  color: #3F2A28 !important;
}

/* å¦‚æœä½ æœ‰ç”¨åˆ° bg-slate-900 ä¹‹é¡çš„ï¼Œä¹Ÿé †ä¾¿äº®ä¸€é» */
.bg-slate-900,
.bg-neutral-900 {
  background-color: #F2E4D4 !important;
}

/* å¡ç‰‡é™°å½±æŸ”ä¸€é»ï¼Œåç™‚ç™’æ„Ÿ */
.shadow-xl,
.shadow-2xl {
  box-shadow: 0 16px 40px rgba(15, 23, 42, 0.22) !important;
}

/* å…§éƒ¨åƒ pixel è¢å¹•é‚£å¡Šï¼Œå¦‚æœ class å« pixel-screenï¼Œå°±é †ä¾¿ç¾åŒ– */
.pixel-screen {
  background: #FFFDF9;
  border-radius: 18px;
  border: 1px solid #E5D4C3;
  padding: 10px;
}
/* ===== é¸é …æŒ‰éˆ•é…è‰²ï¼Œé¿å…æŒ‰ä¸‹å»æ•´å€‹åç™½ ===== */

/* å…ˆå‡è¨­æ‰€æœ‰é¸é …æŒ‰éˆ•éƒ½æœ‰åŠ é€™å€‹ classï¼šoption-btn */
.option-btn {
  background: #FFFFFF;
  color: #3F2A28;
  border-radius: 10px;
  border: 1px solid #E3D6C8;
}

/* é»ä¸‹å» / è¢«é¸å–æ™‚ï¼šèƒŒæ™¯åŠ æ·±ï¼Œå­—ä¿æŒæ¸…æ¥š */
.option-btn:active,
.option-btn.selected {
  background: #EAD5BD;
  color: #3B291F;
}

/* å»æ‰æ‰‹æ©Ÿç€è¦½å™¨é‚£ç¨®è—è‰²åç™½æ¡† */
.option-btn {
  -webkit-tap-highlight-color: transparent;
  outline: none;
}
.option-btn:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(199, 165, 130, 0.45);
}
.hidden {
  display: none;
}
/* è“‹åœ¨ pixel ç•«é¢ä¸Š */
    .pixel-screen.with-result {
    }
/* åªæ¨¡ç³ŠèƒŒæ™¯å±¤/è§’è‰²/å°è©±æ¡†ï¼Œçµæœé¢æ¿ä¿æŒæ¸…æ¥š */
.pixel-screen.with-result .scene-base,
.pixel-screen.with-result .scene-fg,
.pixel-screen.with-result #hero,
.pixel-screen.with-result #catClerk,
.pixel-screen.with-result .dialog-box {
  filter: blur(3px);
}


/* === è¦†è“‹ï¼šçµæœå¡ç‰‡æ”¹äº®è‰² === */
.reco-card{
  background: #fffaf2 !important;
  border: 1px solid var(--kk-line-soft) !important;
  color: var(--kk-text-main) !important;
}
.reco-card-title{ color: var(--kk-text-main) !important; }
.reco-card-meta{ color: var(--kk-text-sub) !important; }
.reco-card-note{ color: var(--kk-text-main) !important; opacity: .92; }

.result-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  position: sticky;
  top: 0;
  padding: 2px 0;
  background: linear-gradient(145deg, #fffdf7, #f8e4c8);
  z-index: 2;
}

.result-close{
  width: 34px;
  height: 34px;
  border-radius: 10px;
  border: 1px solid rgba(180,140,90,0.35);
  background: rgba(255,255,255,0.7);
  cursor: pointer;
}


/* æ”¾åœ¨ <style> æœ€å¾Œé¢ */
.choice-card{ padding: 10px 12px; border-radius: 14px; }
.choice-emoji,.mood-emoji,.goal-emoji,.pref-emoji{ font-size: 20px; }
.choice-title,.mood-title,.goal-title,.pref-title{ font-weight: 700; letter-spacing: .02em; }
.choice-sub,.mood-sub,.goal-sub,.pref-sub{ opacity: .9; }




/* å…§å®¹å€å¡Šæ»¾å‹•è¨­å®š */
.result-header, .result-actions { flex: 0 0 auto; z-index: 5; }
#resultStory { flex: 0 0 auto; max-height: 140px; overflow-y: auto; }
#resultCards { flex: 1 1 auto; min-height: 0; overflow-y: auto; }


@media (max-width: 480px){
  .result-panel{
    left: 12px;
    right: 12px;
    top: 12px;
    bottom: 12px;
    width: auto;
    max-height: none;

    transform: none;            /* ä¸è¦ç½®ä¸­ç¸®æ”¾ */
    border-radius: 16px;
    padding: 14px 14px 12px;

    overflow: hidden;           /* å…§éƒ¨è‡ªå·±æ»¾ */
  }

  /* iPhone åº•éƒ¨å®‰å…¨å€ï¼ˆæœ‰ç€æµ·/å°ç™½æ¢æœƒéœ€è¦ï¼‰ */
  .result-actions{
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
  }

  /* å…§å®¹å€åŸŸåˆ†é…ï¼šå¡ç‰‡å€å¯ä»¥åƒæ›´å¤šé«˜åº¦ */
  #resultStory{ max-height: 32vh; overflow-y: auto; }
  #resultCards{ flex: 1 1 auto; min-height: 0; overflow-y: auto; }

  /* å¡ç‰‡æœ¬é«”è®Šå¤§ã€é–“è·è®Šå¤§ */
  .reco-cards{ gap: 10px; }
  .reco-card{ padding: 12px 12px; border-radius: 12px; font-size: 14px; }
  .reco-card-title{ font-size: 15px; }
  .reco-card-meta{ font-size: 12px; }
  .reco-card-note{ font-size: 13px; }

  /* æŒ‰éˆ•æ›´å¥½æŒ‰ï¼ˆæ‰‹æŒ‡å‹å–„ï¼‰ */
  .dialog-btn{ padding: 10px 12px; }
}


/* ===== Result modal (single source) ===== */
.result-panel{
  position: fixed;
  inset: 12px;                  /* å››é‚Šç•™ 12pxï¼Œæ‰‹æ©Ÿå°±æ˜¯æ»¿ç‰ˆæ„Ÿ */
  z-index: 50;

  border-radius: 16px;
  border: 1px solid rgba(180,140,90,0.45);
  background: linear-gradient(145deg, #fffdf7, #f8e4c8);
  box-shadow: 0 18px 40px rgba(0,0,0,0.25);

  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 12px;

  opacity: 0;
  pointer-events: none;
  visibility: hidden;
  transform: translateY(6px);
  transition: opacity .2s ease, transform .2s ease, visibility 0s linear .2s;
}
.result-panel.show{
  opacity: 1;
  pointer-events: auto;
  visibility: visible;
  transform: translateY(0);
  transition-delay: 0s;
}

/* Header / body / footer scrolling */
.result-header{ flex: 0 0 auto; position: sticky; top: 0; z-index: 2; }
.result-actions{ flex: 0 0 auto; position: sticky; bottom: 0; z-index: 2;
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
}
#resultStory{ flex: 0 0 auto; max-height: 30vh; overflow: auto; }
#resultCards{ flex: 1 1 auto; min-height: 0; overflow: auto; }

/* Card UI bigger + nicer */
.reco-cards{ gap: 10px; }
.reco-card{
  background: #fffaf2 !important;
  border: 1px solid rgba(180,140,90,0.35) !important;
  border-radius: 14px;
  padding: 12px 12px;
  font-size: 14px;
}
.result-panel.present{
  inset: 8px;
}
.result-panel.present .reco-card{
  padding: 14px 14px;
}
.result-panel.present .reco-card-title{
  font-size: 18px;
}
.result-panel.present .reco-card-meta{
  font-size: 13px;
}
.result-panel.present .reco-card-note{
  font-size: 14px;
}
.result-panel.present #resultStory{
  max-height: 18vh;
}

/* å‡ºç¤ºæ¨¡å¼ï¼šæ›´åƒã€Œé»é¤æ†‘è­‰ã€ */
.result-panel.present{
  inset: 8px;
}
.result-panel.present .reco-card{
  padding: 14px;
  border-radius: 14px;
}
.result-panel.present .reco-card-title{ font-size: 18px; }
.result-panel.present .reco-card-meta{ font-size: 13px; }
.result-panel.present .reco-card-note{ font-size: 14px; }
.result-panel.present #resultStory{ max-height: 18vh; }

/* ===== Button polish (place at END of <style>) ===== */
.dialog-btn{
  -webkit-tap-highlight-color: transparent;
  appearance: none;
  border-radius: 12px; /* åŸæœ¬ 999px å¾ˆå¯æ„›ï¼Œä½†å¡ç‰‡å‹æŒ‰éˆ•ç”¨ 12~14 æ›´ç²¾ç·» */
  padding: 10px 12px; /* ä½ æ‰‹æ©Ÿç‰ˆå·²ç¶“æœ‰åŠ å¤§ï¼Œé€™è£¡çµ±ä¸€ */
  font-size: 13px;
  font-weight: 650;
  letter-spacing: .01em;

  border: 1px solid rgba(180,140,90,0.45);
  background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(249,239,227,0.92));
  color: var(--kk-text-main);

  box-shadow:
    0 1px 0 rgba(255,255,255,0.8) inset,
    0 8px 18px rgba(0,0,0,0.10);
  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, background .12s ease;
}

.dialog-btn:hover{
  filter: brightness(1.02);
  transform: translateY(-1px);
  box-shadow:
    0 1px 0 rgba(255,255,255,0.85) inset,
    0 10px 22px rgba(0,0,0,0.14);
}

.dialog-btn:active{
  transform: translateY(0);
  filter: brightness(0.99);
  box-shadow:
    0 1px 0 rgba(255,255,255,0.75) inset,
    0 5px 12px rgba(0,0,0,0.12);
}

.dialog-btn:focus-visible{
  outline: none;
  box-shadow:
    0 1px 0 rgba(255,255,255,0.85) inset,
    0 10px 22px rgba(0,0,0,0.14),
    0 0 0 4px rgba(196,138,58,0.18);
}

/* Primaryï¼šæ›´åƒã€Œä¸» CTAã€ */
.dialog-btn-primary{
  border-color: rgba(196,138,58,0.55);
  background:
    radial-gradient(circle at 20% 0%, rgba(255,255,255,0.75), transparent 55%),
    linear-gradient(135deg, #ffcf6b, #ff9f3f);
  color: #3b2515;
  box-shadow:
    0 1px 0 rgba(255,255,255,0.6) inset,
    0 10px 22px rgba(0,0,0,0.18);
}

.dialog-btn-primary:hover{
  transform: translateY(-1px);
  box-shadow:
    0 1px 0 rgba(255,255,255,0.65) inset,
    0 12px 26px rgba(0,0,0,0.22);
}
/* ===== Mobile full-bleed (place at END of <style>) ===== */
@media (max-width: 480px){
  body{
    padding-top: 0;
    align-items: stretch;      /* åŸæœ¬ center æœƒé€ æˆä¸Šä¸‹ç•™ç™½è¦–è¦ºæ›´æ˜é¡¯ */
    justify-content: flex-start;
    min-height: 100dvh;
  }

  .game-shell{
    width: 100%;
    max-width: none;
    min-height: 100dvh;        /* é—œéµï¼šæ•´å°ã€Œä¸»æ©Ÿã€æ»¿ç‰ˆ */
    border-radius: 0;          /* æƒ³è¦æ»¿ç‰ˆæ„Ÿå°±æ‹¿æ‰ï¼›æƒ³ä¿ç•™å¯æ”¹ 16px */
    padding: 12px;
    box-shadow: none;          /* æ»¿ç‰ˆé€šå¸¸ä¸éœ€è¦å¤–é™°å½± */
    display: flex;
    flex-direction: column;
  }

  .screen{
    flex: 1;
    width: 100%;
  }
}
/* ===== Glassmorphism Tech Buttons (paste at END of <style>) ===== */

/* å¯é¸ï¼šèª¿æ•´ç§‘æŠ€æ„Ÿè‰²ç³»ï¼ˆä¸æ”¹ä¹Ÿè¡Œï¼‰ */
:root{
  --glass-edge: rgba(255,255,255,0.55);
  --glass-fill-1: rgba(255,255,255,0.22);
  --glass-fill-2: rgba(255,255,255,0.10);
  --glass-stroke: rgba(180,140,90,0.35);   /* æ²¿ç”¨ä½ åŸæœ¬ line-soft çš„èª¿æ€§ */
  --neon-warm: rgba(255, 171, 64, 0.35);   /* æ©˜é‡‘å…‰æšˆ */
  --neon-cool: rgba( 64, 180, 255, 0.18);  /* å†·è‰²è¼”åŠ©ï¼ˆç§‘æŠ€æ„Ÿï¼‰ */
}

/* ç»ç’ƒåº•æŒ‰éˆ•ï¼ˆæ¬¡è¦/ä¸€èˆ¬ï¼‰ */
.dialog-btn{
  position: relative;
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;

  border-radius: 14px;
  padding: 11px 12px;
  font-size: 13px;
  font-weight: 650;
  letter-spacing: .01em;
  color: var(--kk-text-main);

  border: 1px solid var(--glass-stroke);
  background:
    linear-gradient(135deg, var(--glass-fill-1), var(--glass-fill-2));
  backdrop-filter: blur(14px) saturate(1.25);
  -webkit-backdrop-filter: blur(14px) saturate(1.25);

  box-shadow:
    0 1px 0 var(--glass-edge) inset,
    0 10px 24px rgba(0,0,0,0.14),
    0 0 0 1px rgba(255,255,255,0.12);

  transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, border-color .12s ease;
}

/* æƒå…‰ï¼ˆç§‘æŠ€æ„Ÿé—œéµï¼‰ */
.dialog-btn::before{
  content:"";
  position:absolute;
  inset:-40% -60%;
  background:
    linear-gradient(110deg,
      transparent 0%,
      rgba(255,255,255,0.18) 35%,
      rgba(255,255,255,0.42) 50%,
      rgba(255,255,255,0.18) 65%,
      transparent 100%);
  transform: translateX(-35%) rotate(6deg);
  opacity: 0.0;
  transition: opacity .18s ease, transform .35s ease;
  pointer-events:none;
}

.dialog-btn:hover{
  transform: translateY(-1px);
  border-color: rgba(255,255,255,0.55);
  box-shadow:
    0 1px 0 rgba(255,255,255,0.65) inset,
    0 14px 30px rgba(0,0,0,0.18),
    0 0 26px var(--neon-cool);
}

.dialog-btn:hover::before{
  opacity: 0.9;
  transform: translateX(8%) rotate(6deg);
}

.dialog-btn:active{
  transform: translateY(0px);
  filter: brightness(0.99);
  box-shadow:
    0 1px 0 rgba(255,255,255,0.55) inset,
    0 8px 18px rgba(0,0,0,0.16);
}

.dialog-btn:focus-visible{
  outline: none;
  box-shadow:
    0 1px 0 rgba(255,255,255,0.65) inset,
    0 14px 30px rgba(0,0,0,0.18),
    0 0 0 4px rgba(196,138,58,0.18),
    0 0 28px var(--neon-warm);
}

/* ä¸» CTAï¼šæ›´äº®ã€æ›´ã€Œèƒ½é‡æ ¸å¿ƒã€ */
.dialog-btn-primary{
  border-color: rgba(255,255,255,0.65);
  background:
    radial-gradient(circle at 20% 0%,
      rgba(255,255,255,0.40),
      rgba(255,255,255,0.10) 60%),
    linear-gradient(135deg,
      rgba(255, 210, 120, 0.55),
      rgba(255, 160, 60, 0.28));
  color: #2e1f18;
  box-shadow:
    0 1px 0 rgba(255,255,255,0.70) inset,
    0 16px 34px rgba(0,0,0,0.20),
    0 0 34px var(--neon-warm);
}

.dialog-btn-primary:hover{
  box-shadow:
    0 1px 0 rgba(255,255,255,0.75) inset,
    0 18px 38px rgba(0,0,0,0.22),
    0 0 42px var(--neon-warm),
    0 0 24px var(--neon-cool);
}
.result-cta-note{
  margin-top: 6px;
  padding: 6px 8px;
  border-radius: 10px;
  border: 1px solid rgba(180,140,90,0.25);
  background: rgba(255,255,255,0.30);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.result-cta-row{
  display: flex;
  align-items: baseline;
  gap: 4px;
}

.result-cta-label{
  font-size: 11px;
  font-weight: 700;
  color: var(--kk-accent);
}

.result-cta-text-inline{
  font-size: 11px;
  line-height: 1.5;
  color: var(--kk-text-main);
}

.result-cta-toggle{
  margin-top: 4px;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid rgba(180,140,90,0.35);
  background: rgba(255,255,255,0.6);
  cursor: pointer;
}

.result-cta-links{
  margin-top: 6px;
  display: none;
  flex-direction: column;
  gap: 4px;
}

.result-cta-links.open{
  display: flex;
}

.result-cta-link{
  font-size: 11px;
  text-decoration: none;
  color: var(--kk-text-main);
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.4);
  background: rgba(255,255,255,0.3);
}


.result-cta-link{
  font-size: 12px;
  text-decoration: none;
  color: var(--kk-text-main);
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.35);
  background: rgba(255,255,255,0.16);
}

.result-cta-link:hover{
  filter: brightness(1.03);
  border-color: rgba(255,255,255,0.55);
}

</style>
</head>
<body>
<!-- éŸ³æ•ˆ -->
<audio id="sfxStep"  src="assets/walk.mp3"           preload="auto" loop></audio>
<audio id="sfxOpen"  src="assets/opening-door.mp3"   preload="auto"></audio>
<audio id="sfxBell"  src="assets/Bell_sound.mp3"     preload="auto"></audio>
<audio id="sfxTalk"  src="assets/NES_Talking.mp3"    preload="auto" loop></audio>
<audio id="bgmSelect" src="assets/Chiptune_01.mp3"   preload="auto" loop></audio>
<audio id="sfxSelect" src="assets/Select.mp3"        preload="auto"></audio>
<audio id="sfxCheck"  src="assets/check.mp3"         preload="auto"></audio>
<audio id="bgmInside" src="assets/Chiptune_02.mp3"   preload="auto" loop></audio>
<audio id="sfxClick"  src="assets/click.mp3"         preload="auto"></audio>
<audio id="sfxLevelUp"  src="assets/level_up.mp3"    preload="auto"></audio>
<audio id="sfxNo" src="assets/no.mp3" preload="auto"></audio>
<audio id="sfxThink" src="assets/think.mp3" preload="auto" loop></audio>


<div class="game-shell">
  <div class="title-bar">
    <span>èŠç™‚è²“ Bar Â· é¸æ“‡å›°é›£ç—‡å°å¹«æ‰‹</span><br>
    <small>ä»Šå¤©çš„é¸æ“‡ï¼Œå…ˆäº¤çµ¦ AI è²“åº—é•·æƒ³æƒ³çœ‹</small>
  </div>

  <div class="status-bar">
    <span id="statusTag">è¼‰å…¥å¤©æ°£ä¸­</span>
    <span id="statusTime">--:--</span>
    <span id="statusTemp">--Â°C Â·å°ä¸­å¤§é‡Œ --</span>
  </div>

  <!-- è§’è‰²é¸æ“‡ç•«é¢ -->
  <div id="screen-select" class="screen active">
    <div class="select-top">
      ä»Šå¤©çš„é¸æ“‡å›°é›£ï¼Œ<br>æƒ³äº¤çµ¦å“ªä¸€å€‹ã€Œè‡ªå·±ã€ä¾†è™•ç†ï¼Ÿ
    </div>
    <div class="select-sub">
      å…ˆé¸ä¸€å€‹è§’è‰²å’Œæš±ç¨±ï¼Œç­‰ç­‰é€²å»å¾Œï¼ŒAI è²“åº—é•·æœƒé™ªä½ æ…¢æ…¢ç¿»èœå–®ã€‚
    </div>

    <div class="char-grid">
      <div class="char-card" data-role="boy">
          <img class="char-sprite-img" data-sprite="boy" src="assets/hero-boy-front-1.png" width="44" height="64" alt="">
        <div style="font-size:12px;">ç”·å­©</div>
        <div class="char-role-note">èªçœŸå·¥ä½œä¹Ÿè¦èªçœŸä¼‘æ¯æ‰å¯ä»¥ï¼</div>
      </div>
      <div class="char-card" data-role="girl">
        <img class="char-sprite-img" data-sprite="girl" src="assets/hero-girl-front-1.png" height="64" alt="">
        <div style="font-size:12px;">å¥³ç”Ÿ</div>
        <div class="char-role-note">ä»Šå¤©æœ‰é»ç´¯ Â· æƒ³è¢«å¥½å¥½ç…§é¡§</div>
      </div>
      <div class="char-card" data-role="cat">
        <img class="char-sprite-img" data-sprite="cat" src="assets/hero-cat-front-1.png" height="64" alt="">
        <div style="font-size:12px;">è²“å’ª</div>
        <div class="char-role-note">æˆ‘æ‰“å…¨éƒ¨éƒ½äº¤çµ¦å‘½é‹ä¾†å®‰æ’ï¼</div>
      </div>
    </div>

    <div class="nick-row">
      <label for="nickname">æƒ³è®“è²“åº—é•·æ€éº¼å«ä½ ï¼Ÿï¼ˆå¯ç•™ç™½ï¼‰</label>
      <input
        id="nickname"
        type="text"
        maxlength="10"
        placeholder="ä¾‹å¦‚ï¼šå°è²“å¥´ã€åŠ ç­å€–å­˜è€…ã€é¸æ“‡å›°é›£æ‚£è€…â€¦"
      />
    </div>

    <button id="btnStart" class="btn-primary" disabled>
      é¸å¥½äº†ï¼Œå¸¶æˆ‘å»æ‰¾ã€Œä»Šå¤©é‚£ä¸€ä»½ã€å§ï¼
    </button>

    <div class="small-hint">
      å…ˆé¸è§’è‰²å†æŒ‰é–‹å§‹ã€‚æ²’å¡«æš±ç¨±å°±å«ã€Œä»Šå¤©çš„å®¢äººã€å›‰ï¼
    </div>
  </div>

  <!-- éŠæˆ²ä¸»ç•«é¢ -->
  <div id="screen-game" class="screen">
    <div class="pixel-screen">
      <!-- å¤–æ™¯ base + fg -->
      <div id="sceneOutsideBase" class="scene-base scene--outside-base active"></div>
      <div id="sceneOutsideFg"   class="scene-fg   scene--outside-fg active"></div>

      <!-- å…§æ™¯ base + fg -->
      <div id="sceneInsideBase"  class="scene-base scene--inside-base"></div>
      <div id="sceneInsideFg"    class="scene-fg   scene--inside-fg"></div>

      <!-- ä¸»è§’ & è²“åº—é•· -->
      <div id="hero" class="hero hero--boy-front"></div>
      <div id="catClerk" class="cat-clerk cat-clerk-idle"></div>

      <!-- å°è©±æ¡† -->
      <div class="dialog-box">
        <div id="dialogLabel" class="dialog-label">ç³»çµ±</div>
        <div id="dialogText" class="dialog-text"></div>
        <div id="dialogChoices" class="dialog-choices"></div>
      </div>


<!-- æœ€çµ‚æ¨è–¦å¡ç‰‡ -->
<div id="resultPanel" class="result-panel">
  <div class="result-header">
    <div class="result-title">AI è²“åº—é•·çµ¦ä½ çš„ã€Œä»Šå¤©é‚£ä¸€ä»½ã€</div>
  </div>

  <div id="resultStory" class="result-story"></div>
  <div id="resultCards" class="reco-cards"></div>

  <!-- âœ… é€™æ®µå°±æ˜¯ä½ è¦æ–°å¢çš„å°æé†’ï¼ˆæ”¾åœ¨å¡ç‰‡ä¸‹æ–¹ã€æŒ‰éˆ•ä¸Šæ–¹ï¼‰ -->
  <div class="result-cta-note" id="resultCtaNote">
  <div class="result-cta-row">
    <span class="result-cta-label">å°æé†’ï¼š</span>
    <span class="result-cta-text-inline">
      å¦‚æœè¦ºå¾—æˆ‘å€‘çš„æœå‹™é‚„ä¸éŒ¯ï¼Œä¹Ÿæ­¡è¿åœ¨ IG / Threads æ¨™è¨˜æˆ‘å€‘ï¼Œæˆ‘å€‘æœƒä¸å®šæ™‚èˆ‰è¾¦æŠ½çå°æ´»å‹•ï¼
    </span>
  </div>
  <button class="result-cta-toggle" type="button" onclick="
    const links = document.getElementById('resultCtaLinks');
    links.classList.toggle('open');
  ">
    æŸ¥çœ‹ç¤¾ç¾¤å¸³è™Ÿ
  </button>

  <div class="result-cta-links" id="resultCtaLinks">
    <a class="result-cta-link" href="https://www.instagram.com/ttkcafebar/" target="_blank" rel="noopener">
      å’–å•¡å»³ IGï¼š@ttkcafebar
    </a>
    <a class="result-cta-link" href="https://www.threads.net/@ttkcafebar" target="_blank" rel="noopener">
      å’–å•¡å»³ Threadsï¼š@ttkcafebar
    </a>
    <a class="result-cta-link" href="https://www.instagram.com/talktokitties.bar/" target="_blank" rel="noopener">
      å…±å­¸ç©ºé–“ IGï¼š@talktokitties.bar
    </a>
    <a class="result-cta-link" href="https://www.threads.net/@talktokitties.bar" target="_blank" rel="noopener">
      å…±å­¸ç©ºé–“ Threadsï¼š@talktokitties.bar
    </a>
  </div>
</div>


  <div class="result-actions">
    <button id="btnConfirm" class="dialog-btn dialog-btn-primary" type="button">æˆ‘å°±è¦é€™ä»½ï¼Œæ‹¿å»æ«ƒå°</button>
    <button id="btnRedo" class="dialog-btn" type="button">æƒ³é‡ä¾†ä¸€è¼ª</button>
    <button id="btnExit" class="dialog-btn" type="button">çµæŸ</button>
  </div>

  <!-- Loading å°å¡ç‰‡ï¼ˆè¦†è“‹åœ¨çµæœé¢æ¿ä¸Šï¼‰ -->
<div id="resultLoading" class="result-loading hidden">
  <div class="result-loading-card">
    <div class="result-loading-cats">
      <img src="assets/cat-thinking-1.png" alt="è²“åº—é•·æ€è€ƒ1">
      <img src="assets/cat-thinking-2.png" alt="è²“åº—é•·æ€è€ƒ2">
      <img src="assets/cat-thinking-3.png" alt="è²“åº—é•·æ€è€ƒ3">
    </div>
    <div class="result-loading-text">
      AI è²“åº—é•·æ­£åœ¨åŠªåŠ›ç¿»é–±èœå–®ï¼Œå¹«ä½ æ‰¾ä»Šå¤©æœ€é©åˆçš„å°å¤¥ä¼´æ¨è–¦çµ„åˆä¸­â€¦
     <span class="loading-dots"></span>
    </div>
  </div>
</div>



<script>
const dialogTextEl    = document.getElementById("dialogText");
const dialogLabelEl   = document.getElementById("dialogLabel");
const dialogChoicesEl = document.getElementById("dialogChoices");
const dialogBoxEl     = document.querySelector(".dialog-box");
const resultPanelEl   = document.getElementById("resultPanel");
const resultStoryEl   = document.getElementById("resultStory");
const resultCardsEl   = document.getElementById("resultCards");
const btnRedoEl       = document.getElementById("btnRedo");
const resultLoadingEl = document.getElementById("resultLoading"); // â† æ–°å¢
const btnConfirmEl = document.getElementById("btnConfirm");
const btnExitEl    = document.getElementById("btnExit");


let aiAbort = null;

// ===== éåŒæ­¥è«‹æ±‚æ§åˆ¶ï¼ˆé¿å…é‡ä¾†å¾ŒèˆŠè«‹æ±‚å›ä¾†è¦†è“‹æ–°çµæœï¼‰=====
let weatherAbort = null;

function abortPendingRequests() {
  if (weatherAbort) { weatherAbort.abort(); weatherAbort = null; }
  if (aiAbort) { aiAbort.abort(); aiAbort = null; }
}

// ===== çµ±ä¸€ï¼šçµæœé¢æ¿é¡¯ç¤º/éš±è— =====
const pixelScreenEl = document.querySelector(".pixel-screen");

function openResultPanel() {
  resultPanelEl.classList.add("show");
  pixelScreenEl.classList.add("with-result");
}

function exitToSelect(){
  // å…ˆé—œçµæœï¼ˆæœƒ stop thinkã€æ¸…ç©ºã€abort pendingï¼‰[file:4]
  closeResultPanel();

  // æ¸…æ‰å‡ºç¤ºæ¨¡å¼æ¨£å¼
  resultPanelEl.classList.remove("present");

  // å›åˆ°é¸è§’ç•«é¢
  screenGame.classList.remove("active");
  screenSelect.classList.add("active");

  // åœå®¤å…§ BGMï¼Œé¿å…å›å»é‚„åœ¨æ’­ï¼ˆä½ æœ‰ bgmInside/bgmSelectï¼‰[file:4]
  stopSfx(bgmInside);
  // å¦‚æœä½ å¸Œæœ›å›é¸è§’æ™‚è‡ªå‹•æ’­ bgmSelectï¼Œä¹Ÿå¯ä»¥æ”¹æˆ playSfx(bgmSelect)
}

function closeResultPanel() {
  resultPanelEl.classList.remove("show");
  pixelScreenEl.classList.remove("with-result");
  resetThinkingHard();
  resultCardsEl.textContent = "";
  resultStoryEl.textContent = "";
  abortPendingRequests();
}



// åªä¿ç•™é€™ä¸€å€‹é‡ä¾†äº‹ä»¶ï¼ˆç¢ºä¿ä½ å·²åˆªæ‰æª”æ¡ˆå°¾ç«¯é‚£å€‹é‡è¤‡ listenerï¼‰
btnRedoEl.addEventListener("click", (e) => {
  e.stopPropagation();
  playSfx(sfxClick);
  closeResultPanel();
  startQuestionFlow();
});
 btnConfirmEl.addEventListener("click", () => {
  playSfx(sfxCheck);
  resultPanelEl.classList.add("present");
  // é€™è£¡ä¹Ÿå¯ä»¥é †ä¾¿æŠŠ scroll å®šä½åˆ°æœ€ä¸Šé¢ï¼Œè®“åº—å“¡ä¸€çœ¼çœ‹åˆ°å“é …
  resultPanelEl.scrollTo({ top: 0, behavior: "smooth" });
});

btnExitEl.addEventListener("click", () => {
  playSfx(sfxClick);
  exitToSelect();   // ä¸‹é¢æœƒæ–°å¢é€™å€‹ function
});

// ===== çµ±ä¸€ï¼šAI å•ç­”ç‹€æ…‹é‡ç½® =====
const DEFAULT_PREFS = {
  vegetarian:false,
  noBeef:false,
  avoidMilk:false,
  noIce:false,
  period:false,
  pregnant:false,
  noCaffeine:false
};

const DEFAULT_BODY_NEEDS = { light:false, nourish:false, warm:false };

function resetAiState() {
  state.goals = [];
  state.prefs = { ...DEFAULT_PREFS };
  state.mood = null;
  state.purpose = null;
  state.bodyNeeds = { ...DEFAULT_BODY_NEEDS };

  state.mealSizePref = null;
  state.mealFlavorPref = null;
  state.mealBaseBias = ["toast","pizza","pasta"];
  state.dessertPersona = null;

  state.askedDrink = false;
  state.askedMeal = false;
  state.askedDessert = false;

  state.timeHour = new Date().getHours();
}


const statusTagEl  = document.getElementById("statusTag");
const statusTimeEl = document.getElementById("statusTime");
const statusTempEl = document.getElementById("statusTemp");

const sfxStep    = document.getElementById("sfxStep");
const sfxOpen    = document.getElementById("sfxOpen");
const sfxBell    = document.getElementById("sfxBell");
const sfxTalk    = document.getElementById("sfxTalk");
const bgmSelect  = document.getElementById("bgmSelect");
const sfxSelect  = document.getElementById("sfxSelect");
const sfxCheck   = document.getElementById("sfxCheck");
const bgmInside  = document.getElementById("bgmInside");
const sfxClick   = document.getElementById("sfxClick");
const sfxLevelUp = document.getElementById("sfxLevelUp");
const sfxNo = document.getElementById('sfxNo');
const sfxThink = document.getElementById('sfxThink');


function playSfx(audioEl) {
  if (!audioEl) return;
  audioEl.currentTime = 0;
  audioEl.play();
}
function stopSfx(audioEl) {
  if (!audioEl) return;
  audioEl.pause();
  audioEl.currentTime = 0;
}
let thinkingRef = 0;

function enterThinking() {
  thinkingRef++;
  resultLoadingEl.classList.remove("hidden");
  if (thinkingRef === 1) playSfx(sfxThink);
}

function leaveThinking() {
  thinkingRef = Math.max(0, thinkingRef - 1);
  if (thinkingRef === 0) {
    resultLoadingEl.classList.add("hidden");
    stopSfx(sfxThink);
  }
}

function resetThinkingHard() {
  thinkingRef = 0;
  resultLoadingEl.classList.add("hidden");
  stopSfx(sfxThink);
}


function setThinking(isThinking) {
  if (isThinking) enterThinking();
  else leaveThinking();
}




/* å¤©æ°£ï¼‹AI ç‹€æ…‹ï¼šopenâ€‘meteo + èœå–®å•å· */
const state = {
  step: 'game',
  userName: '',
  goals: [],
  prefs: {
    vegetarian:false,
    noBeef:false,
    avoidMilk:false,
    noIce:false,
    period:false,
    pregnant:false,
    noCaffeine:false
  },
  mood: null,
  purpose: null,                // â˜… æ–°å¢ï¼šä»Šå¤©çš„ã€Œç›®çš„ã€
  bodyNeeds: { light:false, nourish:false, warm:false },
  weather: {
    temp: 24,
    tag: 'mild',
    condition: 'none',
    desc: ''
  },
  timeHour: new Date().getHours()
};

/* ç‹€æ…‹åˆ—æ™‚é–“ */
function updateClock() {
  const now = new Date();
  const hh = now.getHours().toString().padStart(2,'0');
  const mm = now.getMinutes().toString().padStart(2,'0');
  statusTimeEl.textContent = `${hh}:${mm}`;
  state.timeHour = now.getHours();
}
updateClock();
setInterval(updateClock, 60000);

function isRainCode(code) {
  return (code >= 51 && code <= 67) || (code >= 80 && code <= 99);
}

let weatherCache = { ts: 0, data: null, lastOkTs: 0 }; // 10 åˆ†é˜å…§ä¸é‡æŠ“
fetchWeather();


async function fetchWeather() {
  const now = Date.now();
  if (weatherCache.data && (now - weatherCache.ts) < 10 * 60 * 1000) {
    const { temp, desc, tag, condition } = weatherCache.data;
    state.weather.temp = temp;
    state.weather.tag = tag;
    state.weather.condition = condition;
    state.weather.desc = desc;
    statusTagEl.textContent  = desc;
    statusTempEl.textContent = `${temp}Â°C Â· å°ä¸­å¤§é‡Œ`;
    return;
  }

  try {
    if (weatherAbort) weatherAbort.abort();
    weatherAbort = new AbortController();

    const res = await fetch(
      "https://api.open-meteo.com/v1/forecast?latitude=24.099&longitude=120.677&current_weather=true&timezone=Asia%2FTaipei",
      { signal: weatherAbort.signal }
    );
    const data = await res.json();
    console.log("ğŸ“¦ å®Œæ•´å›æ‡‰ data:", data);
    if (!data.current_weather) throw new Error("no current_weather");

    const cw = data.current_weather;
    const temp = cw.temperature;
    const code = cw.weathercode;

    const isHot = temp >= 26;
    const isCold = temp <= 19;
    const raining = isRainCode(code);

    let desc = "èˆ’é©";
    if (raining) desc = "å¤–é¢æ­£åœ¨ä¸‹é›¨";
    else if (isHot) desc = "å¤–é¢åç†±";
    else if (isCold) desc = "å¤–é¢åæ¶¼";

    const tag = isHot ? "hot" : (isCold ? "cold" : "mild");
    const condition = raining ? "rain" : "none";

    weatherCache = { ts: Date.now(), data: { temp, desc, tag, condition }, lastOkTs: Date.now() };
    function fmtHHMM(ts){
  const d = new Date(ts);
  return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

    state.weather.temp = temp;
    state.weather.tag = tag;
    state.weather.condition = condition;
    state.weather.desc = desc;

    statusTagEl.textContent  = desc;
    statusTempEl.textContent = `${temp}Â°C Â· å°ä¸­å¤§é‡Œ`;
  } catch (e) {
  if (weatherCache.data && weatherCache.lastOkTs) {
    const { temp, desc } = weatherCache.data;
    statusTagEl.textContent  = `${desc}ï¼ˆæ›´æ–°å¤±æ•—ï¼Œæœ€å¾Œæ›´æ–° ${fmtHHMM(weatherCache.lastOkTs)}ï¼‰`;
    statusTempEl.textContent = `${temp}Â°C Â· å°ä¸­å¤§é‡Œ`;
  } else {
    statusTagEl.textContent  = "ç‹€æ…‹è®€å–å¤±æ•—";
    statusTempEl.textContent = "â€”Â°C Â· â€”";
  }
}

    finally {
    weatherAbort = null;
  }
}


let typeTimer = null;
function typeText(text, speed, onDone) {
  if (typeTimer) {
    clearInterval(typeTimer);
    typeTimer = null;
  }
  stopSfx(sfxTalk);

  dialogTextEl.textContent = "";
  let i = 0;
  const len = text.length;

  playSfx(sfxTalk);

  typeTimer = setInterval(() => {
    if (i >= len) {
      clearInterval(typeTimer);
      typeTimer = null;
      stopSfx(sfxTalk);
      onDone && onDone();
      return;
    }
    dialogTextEl.textContent += text[i];
    i++;
  }, speed);
}

function addDialogButton(label, handler) {
  const btn = document.createElement("button");
  btn.className = "dialog-btn choice-card";
  btn.textContent = label;
  btn.addEventListener("click", () => {
    playSfx(sfxClick);
    handler();
  });
  dialogChoicesEl.appendChild(btn);
}

let currentRole = "boy";
let nickname = "ä»Šå¤©çš„å®¢äºº";

const screenSelect  = document.getElementById("screen-select");
const screenGame    = document.getElementById("screen-game");
const btnStart      = document.getElementById("btnStart");
const nicknameInput = document.getElementById("nickname");
const charCards     = document.querySelectorAll(".char-card");

const sceneOutsideBase = document.getElementById("sceneOutsideBase");
const sceneOutsideFg   = document.getElementById("sceneOutsideFg");
const sceneInsideBase  = document.getElementById("sceneInsideBase");
const sceneInsideFg    = document.getElementById("sceneInsideFg");

const heroEl     = document.getElementById("hero");
const catClerkEl = document.getElementById("catClerk");

// ===== è§’è‰²é¸æ“‡ï¼šå››æ ¼å¾…æ©Ÿå‹•ç•«ï¼ˆå…¨åŸŸï¼‰=====
const ROLE_FRAMES = {
  boy: [
    'assets/hero-boy-front-1.png',
    'assets/hero-boy-front-2.png',
    'assets/hero-boy-front-3.png',
    'assets/hero-boy-front-4.png'
  ],
  girl: [
    'assets/hero-girl-front-1.png',
    'assets/hero-girl-front-2.png',
    'assets/hero-girl-front-3.png',
    'assets/hero-girl-front-4.png'
  ],
  cat: [
    'assets/hero-cat-front-1.png',
    'assets/hero-cat-front-2.png',
    'assets/hero-cat-front-3.png',
    'assets/hero-cat-front-4.png'
  ]
};

let selectAnimTimer = null;

function setRoleSprite(role, frameIndex) {
  const el = document.querySelector(`.char-sprite-img[data-sprite="${role}"]`);
  if (!el) return;
  el.src = ROLE_FRAMES[role][frameIndex];
}

function stopSelectAnim() {
  if (selectAnimTimer) clearInterval(selectAnimTimer);
  selectAnimTimer = null;
  Object.keys(ROLE_FRAMES).forEach(role => setRoleSprite(role, 0)); // å…¨éƒ¨å›åˆ°ç¬¬ 1 å¼µ
}

function startSelectAnim(role) {
  // å…ˆæŠŠå…¶ä»–è§’è‰²å›åˆ°ç¬¬ 1 å¼µ
  Object.keys(ROLE_FRAMES).forEach(r => { if (r !== role) setRoleSprite(r, 0); });

  if (selectAnimTimer) clearInterval(selectAnimTimer);

  let idx = 0; // 0 = ç¬¬ 1 å¼µ
  selectAnimTimer = setInterval(() => {
    idx = (idx + 1) % ROLE_FRAMES[role].length;
    setRoleSprite(role, idx);
  }, 140);
}


/* é¸è§’è‰² */
charCards.forEach(card => {
  card.addEventListener("click", () => {
    const role = card.dataset.role;
    startSelectAnim(role);            // æ–°å¢ï¼šé»èª°å°±æ’­èª°çš„ 4 å¼µ [file:1]
    playSfx(sfxSelect);
    charCards.forEach(c => c.classList.remove("active"));
    card.classList.add("active");
    currentRole = card.dataset.role;
    heroEl.className = "hero hero--" + currentRole + "-front";
    btnStart.disabled = false;

  });
});

/* ç¬¬ä¸€æ¬¡é»ç•«é¢å•Ÿå‹• BGM */
document.addEventListener("click", function initBgmOnce() {
  playSfx(bgmSelect);
  document.removeEventListener("click", initBgmOnce);
});

btnStart.addEventListener("click", () => {
  playSfx(sfxCheck);
  stopSfx(bgmSelect);
  stopSelectAnim(); // é€²éŠæˆ²å‰æŠŠé¸è§’å‹•ç•«åœæ‰ã€å›åˆ°ç¬¬1å¼µ
  nickname = nicknameInput.value.trim() || "ä»Šå¤©çš„å®¢äºº";
  state.userName = nickname;
  state.timeHour = new Date().getHours();

  screenSelect.classList.remove("active");
  screenGame.classList.add("active");
  startWalkInSequence();
});

/* èµ°è·¯å‹•ç•«ï¼‹è…³æ­¥ */
let walkFramesTimer = null;
function startWalkFrames() {
  stopWalkFrames();
  playSfx(sfxStep);

  let toggle = false;
  walkFramesTimer = setInterval(() => {
    const base = "hero hero--" + currentRole + "-back-";
    heroEl.className = base + (toggle ? "walk" : "idle");
    toggle = !toggle;
  }, 160);
}
function stopWalkFrames() {
  if (walkFramesTimer) clearInterval(walkFramesTimer);
  walkFramesTimer = null;
  stopSfx(sfxStep);
  heroEl.className = "hero hero--" + currentRole + "-back-idle";
}

/* å¤–æ™¯ï¼šå·¦ä¸‹èµ°åˆ°é–€å£ */
function startWalkInSequence() {
  sceneOutsideBase.classList.add("active");
  sceneOutsideFg.classList.add("active");
  sceneInsideBase.classList.remove("active");
  sceneInsideFg.classList.remove("active");
  catClerkEl.classList.remove("visible");

  dialogBoxEl.classList.remove("visible");
  dialogChoicesEl.innerHTML = "";
  dialogTextEl.textContent  = "";

  const startX = 40;
  const startY = 380;
  const endX   = 280;
  const endY   = 260;

  const totalSteps = 42;
  let step = 0;

  let x = startX;
  let y = startY;
  heroEl.style.left = x + "px";
  heroEl.style.top  = y + "px";

  startWalkFrames();

  const dx = (endX - startX) / totalSteps;
  const dy = (endY - startY) / totalSteps;

  const walkTimerPos = setInterval(() => {
    step++;

    x += dx;
    y += dy;
    heroEl.style.left = x + "px";
    heroEl.style.top  = y + "px";

    if (step >= totalSteps) {
      clearInterval(walkTimerPos);
      stopWalkFrames();
      heroEl.style.left = endX + "px";
      heroEl.style.top  = endY + "px";
      heroEl.className  = "hero hero--" + currentRole + "-back-idle";

      // å®¢äººç«™å¥½å¾Œï¼Œè²“åº—é•·å¾èˆ‰æ‰‹æ”¹æˆæ‰‹æ”¾ä¸‹
      catClerkEl.classList.remove("cat-clerk-idle");
      catClerkEl.classList.add("cat-clerk-talk");

      dialogBoxEl.classList.add("visible");

      const introWalkText =
        "Hiã€Œ" + nickname + "ã€ï¼Œæ­¡è¿å…‰è‡¨ èŠç™‚è²“barï¼ \n\n" +
        "æ¥ä¸‹ä¾†å°±äº¤çµ¦æˆ‘å€‘åº—è£¡æœ€å²å®³çš„ AI è²“åº—é•·ï¼Œ" +
        "å¹«ä½ ç¿»ç¿»èœå–®ï¼Œæ¨è–¦ä¸€ä»½æœ€é©åˆä½ ä»Šå¤©çš„é¤é»å§ï¼";

      typeText(introWalkText, 35, () => {
        playSfx(sfxOpen);
        setTimeout(() => {
          enterShopIntro();
        }, 2000);
      });
    }
  }, 80);
}

/* é€²åº—ï¼šå®¤å…§å·¦ä¸‹èµ°åˆ°å§å°å‰ */
function enterShopIntro() {
  sceneOutsideBase.classList.remove("active");
  sceneOutsideFg.classList.remove("active");
  sceneInsideBase.classList.add("active");
  sceneInsideFg.classList.add("active");

  // ä¸€é€²é–€å°±çœ‹åˆ°èˆ‰æ‰‹çš„è²“åº—é•·ï¼ˆå¼·åˆ¶ reset classï¼‰
  catClerkEl.className = "cat-clerk cat-clerk-idle visible";
  catClerkEl.classList.add("visible");
  playSfx(sfxBell);

  stopSfx(bgmSelect);
  playSfx(bgmInside);

  dialogBoxEl.classList.remove("visible");
  stopWalkFrames();

  const startX = 40;
  const startY = 380;
  const endX   = 240;
  const endY   = 220;

  const totalSteps = 30;
  let step = 0;

  let x = startX;
  let y = startY;
  heroEl.style.left = x + "px";
  heroEl.style.top  = y + "px";

  startWalkFrames();

  const dx = (endX - startX) / totalSteps;
  const dy = (endY - startY) / totalSteps;

  const walkInsideTimer = setInterval(() => {
    step++;

    x += dx;
    y += dy;
    heroEl.style.left = x + "px";
    heroEl.style.top  = y + "px";

    if (step >= totalSteps) {
      clearInterval(walkInsideTimer);
      stopWalkFrames();
      heroEl.style.left = endX + "px";
      heroEl.style.top  = endY + "px";
      heroEl.className  = "hero hero--" + currentRole + "-back-idle";

      // å®¢äººç«™åˆ°é¢å‰çš„ç¬é–“ï¼šè²“å¾èˆ‰æ‰‹ -> æ‰‹æ”¾ä¸‹
      catClerkEl.classList.remove("cat-clerk-idle");
      catClerkEl.classList.add("cat-clerk-talk");

      dialogBoxEl.classList.add("visible");
      showIntroDialogue();
    }
  }, 80);
}

/* é€²åº—å¾Œé–‹å ´ */
function showIntroDialogue() {
  dialogLabelEl.textContent = "AIè²“åº—é•·";
  dialogChoicesEl.innerHTML = "";

  const introText =
    "å–µï½ ä½ å¥½å•Šï½" + nickname + "æ—¢ç„¶ä½ æœƒä¾†åˆ°é€™è£¡ï¼Œä»£è¡¨ä½ ä»Šå¤©çš„é¸æ“‡å›°é›£ç—‡æœ‰åˆç™¼ä½œäº†æ˜¯å§ï¼Ÿ\n\n" +
    "æ²’é—œä¿‚ï¼Œå°±è®“æœ¬å–µä¾†å¹«ä½ æ‰¾å‡ºæœ€é©åˆä½ çš„é¤é»å§ï¼Œå¦‚ä½•ï¼Ÿã€‚";

  typeText(introText, 35, () => {
    dialogChoicesEl.innerHTML = "";
    addDialogButton("å¥½å•Šï¼Œæ‹œè¨—ä½ äº†ï¼", () => {
      startQuestionFlow();
    });
    addDialogButton("ä¸è¦ï¼Œæˆ‘æƒ³è‡ªå·±çœ‹èœå–®", () => {
      handleFakeRefuse();
    });
  });
}

function handleFakeRefuse() {
  playSfx(sfxNo); // æ–°å¢ï¼šå›è¦†åŒæ™‚æ’­ no.mp3
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  const text =
    "æ¬¸æ¬¸æ¬¸ï¼Œé‚£ä½ å‰›å‰›æ˜¯ç‚ºä»€éº¼é‚„è¦ç‰¹åœ°æƒ QRcodeä¾†çœ‹æˆ‘å•¦ï¼Ÿ\n\n" +
    "éƒ½èµ°åˆ°æ«ƒæª¯å‰äº†ï¼Œä»£è¡¨ä½ å…¶å¯¦è¶…éœ€è¦æœ¬å–µçš„å»ºè­°å§ã€‚\n" +
    "ä¾†å˜›ï½ï½çµ¦æˆ‘ 30 ç§’ï¼Œæœ¬å–µå¯ä»¥å¹«ä½ å°‘çŒ¶è±«10åˆ†é˜è€¶ã€‚";

  typeText(text, 35, () => {
    dialogChoicesEl.innerHTML = "";
    addDialogButton("å¥½å•¦å¥½å•¦ï¼Œä½ é–‹å§‹å•å§", () => {
      startQuestionFlow();
    });
  });
}

/* ================== AI è²“åº—é•·ï¼šèœå–®è³‡æ–™ï¼‹æ‰“åˆ†é‚è¼¯ ================== */

  const MENU_ITEMS = [
      {id: "brown_sugar_bubble_milk_tea",name: "é»‘ç³–çç é®®å¥¶èŒ¶",category: "é®®å¥¶ç‰¹èª¿",mainType: "drink",caffeine: "normal",milk: true,ginger: false,sugarLevel: "normal",
  canMakeUnsweetened: false,tempOptions: "both",bodySupport: ["nourish","warm"],moodTag: "relax",weatherTag: "cold", vegType: "none",effectTags: [],internalNote: "é»‘ç³–èœœçç æ­é…ç´…èŒ¶èˆ‡é®®å¥¶ï¼Œç”œåº¦æ˜é¡¯ã€å£æ„Ÿæœ‰åš¼å‹ï¼Œé©åˆéœ€è¦è¢«ç”œé£²å¥½å¥½å®‰æ’«çš„æ™‚å€™ã€‚"},
      { id:"sakura_lychee_apple", name:"æ«»æˆ€æ¸…éœ²", category:"å†°ç³–èŠ±é‡€é£²", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["light"], moodTag:"photo", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"æ«»èŠ±è˜‹æœè”æé¢¨å‘³æ­èœœæ¼¬æ«»èŠ±ï¼Œé¡å€¼é«˜ã€ç”œè€Œä¸è†©ï¼Œé©åˆæ‹ç…§èˆ‡æƒ³è¢«æº«æŸ”å°å¾…çš„æ™‚å€™ã€‚" },
      { id:"osmanthus_rock_sugar", name:"æ¡‚é¦™å†°éœ²", category:"å†°ç³–èŠ±é‡€é£²", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["light"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"æ¡‚èŠ±é‡€èˆ‡å†°ç³–æ¡‚èŠ±èª¿è£½ï¼ŒèŠ±é¦™æ˜é¡¯ä½†ä¸è†©ï¼Œé©åˆæƒ³æ”¾é¬†åˆä¸æƒ³å¤ªé‡å£å‘³çš„æ™‚å€™ã€‚" },
      { id:"yuzu_honey_soda", name:"éŸ“é¦™æŸšèœœæ°£æ³¡é£²", category:"æ°£æ³¡é£²", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"cold", bodySupport:["light"], moodTag:"relax", weatherTag:"hot", vegType:"none", effectTags:["è§£è†©"], internalNote:"éŸ“åœ‹æŸšå­èœœæ­é…æ°£æ³¡æ°´ï¼Œé…¸ç”œæ¸…çˆ½ï¼Œé©åˆå¤©æ°£ç†±æˆ–åƒå¾—æ¯”è¼ƒæ²¹æ™‚è§£è†©ã€‚" },
      { id:"blue_orange_soda", name:"è—æŸ‘æ©™æ©˜æ°£æ³¡é£²", category:"æ°£æ³¡é£²", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"cold", bodySupport:["light"], moodTag:"photo", weatherTag:"hot", vegType:"none", effectTags:[], internalNote:"è—æŸ‘æ©˜ç³–æ¼¿ï¼‹æŸ³æ©™ç³–æ¼¿åŠ æ°£æ³¡æ°´ï¼Œè—æ©™åˆ†å±¤è¦–è¦ºå¼·çƒˆï¼Œé©åˆæ‹ç…§æ‰“å¡ã€‚" },
      { id:"apple_honey_soda", name:"è˜‹æœèœœä¸æ°£æ³¡é£²", category:"æ°£æ³¡é£²", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"cold", bodySupport:["light"], moodTag:"relax", weatherTag:"hot", vegType:"none", effectTags:[], internalNote:"éŸ“åœ‹è˜‹æœèœœä¸ï¼‹è˜‹æœç³–æ¼¿æ°£æ³¡é£²ï¼Œè˜‹æœé¦™æ¿ƒç”œåº¦åœ“æ½¤ï¼Œé©åˆä¸æ„›å¤ªé…¸çš„äººã€‚" },
      { id:"hidden_soda", name:"éš±è—é™å®šç‰¹èª¿", category:"æ°£æ³¡é£²", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"cold", bodySupport:["light"], moodTag:"surprise", weatherTag:"hot", vegType:"none", effectTags:[], internalNote:"ä¸å®šæœŸæ›´æ›å£å‘³çš„æ°£æ³¡ç‰¹èª¿ï¼Œé©åˆå–œæ­¡åšé®®ã€æ¥å—é©šå–œçš„å®¢äººã€‚" },
      { id:"aroma_black_tea", name:"èœœéŸ»èœœé¦™ç´…èŒ¶", category:"ç´”èŒ¶", mainType:"drink", caffeine:"normal", milk:false, ginger:false, sugarLevel:"unsweetened", canMakeUnsweetened:true, tempOptions:"both", bodySupport:["light"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"å¸¶å¤©ç„¶èœœé¦™çš„ç´…èŒ¶ï¼Œå¯åšç„¡ç³–ï¼Œé©åˆå¹³å¸¸åªå–ç„¡ç³–èŒ¶ã€åˆæƒ³è¦ä¸€é»èŒ¶é¦™çš„äººã€‚" },
      { id:"peach_black_tea", name:"ç™½æ¡ƒèœœé¦™ç´…èŒ¶", category:"ç´”èŒ¶", mainType:"drink", caffeine:"normal", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["light"], moodTag:"photo", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"ç´…èŒ¶åŠ ç™½æ¡ƒæœé¦™ï¼Œé¦™æ°£æ˜é¡¯ã€å°‘å¥³æ„Ÿå¼·ï¼Œå†°é£²ç‰¹åˆ¥é©åˆã€‚" },
      { id:"apple_black_tea", name:"è˜‹æœèœœé¦™ç´…èŒ¶", category:"ç´”èŒ¶", mainType:"drink", caffeine:"normal", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"è˜‹æœé¦™ï¼‹ç´…èŒ¶ï¼Œå‘³é“æº«æš–æŸ”å’Œï¼Œé©åˆç§‹å†¬æˆ–æƒ³å®‰ç©©ä¸€é»çš„æ™‚å€™ã€‚" },
      { id:"earl_grey_tea", name:"å–®å“ä¼¯çˆµèŒ¶", category:"ç´”èŒ¶", mainType:"drink", caffeine:"normal", milk:false, ginger:false, sugarLevel:"unsweetened", canMakeUnsweetened:true, tempOptions:"both", bodySupport:["light"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"ä½›æ‰‹æŸ‘é¦™çš„å¤§äººç³»ç´…èŒ¶ï¼Œå¯åšç„¡ç³–ï¼Œé©åˆæ­ç”œé»ä¹Ÿé©åˆå–®å–ã€‚" },
      { id:"earl_grey_milk_tea", name:"ä¼¯çˆµé®®å¥¶èŒ¶", category:"é®®å¥¶ç‰¹èª¿", mainType:"drink", caffeine:"normal", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"ä¼¯çˆµèŒ¶èˆ‡é®®å¥¶çµåˆï¼Œä½›æ‰‹æŸ‘é¦™èˆ‡å¥¶é¦™ä¸¦å­˜ï¼Œæ˜¯å®‰å…¨åˆæœ‰å±¤æ¬¡çš„å¥¶èŒ¶ã€‚" },
      { id:"choco_au_lait", name:"å¯å¯æ­è•¾", category:"é®®å¥¶ç‰¹èª¿", mainType:"drink", caffeine:"none", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"cold", vegType:"none", effectTags:[], internalNote:"æ¿ƒå¯å¯ï¼‹é®®å¥¶ï¼Œå¤§äººç‰ˆå·§å…‹åŠ›ç‰›å¥¶ï¼Œé©åˆæƒ³è¢«ç”œé£²å®‰æ’«çš„æ™‚å€™ã€‚" },
      { id:"matcha_latte", name:"å®‡æ²»æŠ¹èŒ¶æ‹¿éµ", category:"é®®å¥¶ç‰¹èª¿", mainType:"drink", caffeine:"low", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"æŠ¹èŒ¶å¾®è‹¦å›ç”˜é…é®®å¥¶ï¼Œæ•´é«”æº«æŸ”å¹³è¡¡ï¼Œé©åˆå®‰éœåè‘—çš„æ™‚å€™ã€‚" },
      { id:"brown_sugar_milk", name:"çƒ¤é»‘ç³–é®®å¥¶", category:"é®®å¥¶ç‰¹èª¿", mainType:"drink", caffeine:"none", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish","warm"], moodTag:"relax", weatherTag:"cold", vegType:"none", effectTags:[], internalNote:"çƒ¤é»‘ç³–é¦™æ°£åšå¯¦ï¼Œç”œåº¦é«˜ã€ç™‚ç™’æ„Ÿå¼·ï¼Œé©åˆéœ€è¦è¢«ç”œä¸€ä¸‹çš„æ™‚å€™ã€‚" },
      { id:"ginger_longan_milk", name:"é»‘ç³–è–‘æ±é®®å¥¶", category:"é®®å¥¶ç‰¹èª¿", mainType:"drink", caffeine:"none", milk:true, ginger:true, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["warm","nourish"], moodTag:"relax", weatherTag:"cold", vegType:"none", effectTags:["æš–èº«"], internalNote:"é»‘ç³–ï¼‹è–‘ï¼‹é¾çœ¼ç³»æš–èº«é£²ï¼Œé©åˆèº«é«”æƒ³æš–æš–çš„ã€æƒ³é¤Šèº«çš„æ™‚å€™ã€‚" },
      { id:"espresso", name:"ç¾©å¼æ¿ƒç¸®", category:"å’–å•¡", mainType:"drink", caffeine:"normal", milk:false, ginger:false, sugarLevel:"unsweetened", canMakeUnsweetened:true, tempOptions:"hot", bodySupport:[], moodTag:"wake", weatherTag:"mild", vegType:"none", effectTags:["å¼·æç¥"], internalNote:"çŸ­æ¯æ¿ƒç¸®å’–å•¡ï¼Œé¢¨å‘³é›†ä¸­ã€å’–å•¡å› é«˜ï¼Œé©åˆéœ€è¦å¼·åŠ›æç¥çš„æ™‚å€™ã€‚" },
      { id:"americano", name:"ç¶“å…¸ç¾å¼", category:"å’–å•¡", mainType:"drink", caffeine:"normal", milk:false, ginger:false, sugarLevel:"unsweetened", canMakeUnsweetened:true, tempOptions:"both", bodySupport:["light"], moodTag:"wake", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"æ¸…çˆ½é»‘å’–å•¡ï¼Œé©åˆå·¥ä½œã€é–±è®€æ™‚æ…¢æ…¢å–ã€‚" },
      { id:"cafe_latte", name:"ç¶“å…¸æ‹¿éµ", category:"å’–å•¡", mainType:"drink", caffeine:"normal", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"å’–å•¡ï¼‹ç‰›å¥¶æ¯”ä¾‹å¹³è¡¡ï¼Œè‹¦å‘³è¢«å¥¶é¦™åŒ…èµ·ä¾†ï¼Œæ˜¯æœ€å®‰å…¨çš„å’–å•¡é¸æ“‡ã€‚" },
      { id:"cappuccino", name:"å¡å¸ƒå¥‡è«¾", category:"å’–å•¡", mainType:"drink", caffeine:"normal", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"å¥¶æ³¡è¼ƒå¤šã€å£æ„ŸæŸ”è»Ÿç¶¿å¯†ï¼Œé©åˆå–œæ­¡å¥¶æ³¡çš„äººã€‚" },
      { id:"flavored_latte", name:"é¢¨å‘³æ‹¿éµï¼ˆæ¦›æœï¼é¦™è‰ï¼ç„¦ç³–ï¼ç«ç‘°ï¼ç™½æ¡ƒï¼‰", category:"å’–å•¡", mainType:"drink", caffeine:"normal", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:[], internalNote:"ä»¥æ‹¿éµç‚ºåŸºåº•åŠ é¢¨å‘³ç³–æ¼¿ï¼Œé¦™æ°£èˆ‡ç”œåº¦æ›´æ˜é¡¯ï¼Œé©åˆæƒ³å–ã€Œæœ‰ä¸»é¡Œå‘³é“ã€çš„å’–å•¡ã€‚" },
      { id:"cafe_mocha", name:"ç¾©å¼æ‘©å¡", category:"å’–å•¡", mainType:"drink", caffeine:"normal", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"cold", bodySupport:["nourish"], moodTag:"relax", weatherTag:"cold", vegType:"none", effectTags:[], internalNote:"å’–å•¡åŠ å¯å¯çš„ç”œç³»å’–å•¡ï¼Œé©åˆå–œæ­¡å·§å…‹åŠ›åˆæƒ³è¦å’–å•¡é¦™çš„äººã€‚" },
      { id:"caramel_macchiato", name:"ç„¦ç³–ç‘ªå¥‡æœµ", category:"å’–å•¡", mainType:"drink", caffeine:"normal", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"cold", bodySupport:["nourish"], moodTag:"relax", weatherTag:"hot", vegType:"none", effectTags:[], internalNote:"ä»¥å¥¶é¦™èˆ‡ç„¦ç³–ç‚ºä¸»çš„ç”œç³»å’–å•¡ï¼Œå…¥å£å…ˆç”œå¾Œå¸¶å’–å•¡é¦™ã€‚" },
      { id:"espresso_romano", name:"é¦™æª¸æ°£æ³¡è¥¿è¥¿é‡Œ", category:"å’–å•¡", mainType:"drink", caffeine:"normal", milk:false, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"cold", bodySupport:["light"], moodTag:"wake", weatherTag:"hot", vegType:"none", effectTags:["æç¥"], internalNote:"æª¸æª¬ï¼‹æ°£æ³¡ï¼‹æ¿ƒç¸®å’–å•¡ï¼Œé…¸åº¦èˆ‡å’–å•¡å› éƒ½å¾ˆæœ‰å­˜åœ¨æ„Ÿï¼Œé†’è…¦æ•ˆæœå¼·ã€‚" },
      { id:"chamomile_lavender", name:"èˆ’ç·©æ²‰éœç”˜èŠèŒ¶", category:"èŠ±è‰èŒ¶", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"unsweetened", canMakeUnsweetened:true, tempOptions:"hot_preferred", bodySupport:["nourish","warm"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:["èˆ’ç·©æƒ…ç·’","æ”¾é¬†","åŠ©çœ "], internalNote:"æ´‹ç”˜èŠï¼‹è–°è¡£è‰å¹«åŠ©èˆ’ç·©æƒ…ç·’ã€æ”¾é¬†èˆ‡å…¥ç¡ï¼Œé©åˆä½œç‚ºæ™šä¸Šçš„æ”¶å°¾èŒ¶ã€‚" },
      { id:"peppermint_tea", name:"æ¸…çˆ½æš¢å¿«è–„è·èŒ¶", category:"èŠ±è‰èŒ¶", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"unsweetened", canMakeUnsweetened:true, tempOptions:"hot_preferred", bodySupport:["light"], moodTag:"wake", weatherTag:"hot", vegType:"none", effectTags:["æç¥","é†’è…¦","æ€ç·’æ¸…æ¥š"], internalNote:"è–„è·ï¼‹ç”˜è‰ï¼‹æª¸æª¬ï¼Œæ¸…æ¶¼æ„Ÿæ˜é¡¯ï¼Œå¯å¹«å¿™æç¥ã€è®“æ€ç·’æ›´æ¸…æ¥šã€‚" },
      { id:"rose_herbal", name:"çº–ç´°ä»™å¥³ç«ç‘°èŒ¶", category:"èŠ±è‰èŒ¶", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"unsweetened", canMakeUnsweetened:true, tempOptions:"hot_preferred", bodySupport:["light","nourish"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:["ä¿ƒé€²æ¶ˆåŒ–"], internalNote:"æ´›ç¥ï¼‹ç«ç‘°ï¼Œé…¸ç”œä¸­å¸¶èŠ±é¦™ï¼Œå¹«åŠ©ä¿ƒé€²æ¶ˆåŒ–ï¼Œé©åˆä½œç‚ºé¤å¾Œæº«æŸ”æ”¶å°¾ã€‚" },
      { id:"strawberry_herbal", name:"ç”œå¿ƒé¤Šé¡è‰è“èŒ¶", category:"èŠ±è‰èŒ¶", mainType:"drink", caffeine:"none", milk:false, ginger:false, sugarLevel:"unsweetened", canMakeUnsweetened:true, tempOptions:"hot_preferred", bodySupport:["light","nourish"], moodTag:"relax", weatherTag:"mild", vegType:"none", effectTags:["ç¾å®¹ä¿é¤Š"], internalNote:"è“æœï¼‹æ´›ç¥çµ„åˆï¼Œå¸¶é…¸ç”œèˆ‡èŠ±æœé¦™ï¼Œå¸¸è¢«å¥³ç”Ÿç•¶æˆæ—¥å¸¸ç¾å®¹èª¿ç†çš„å°å¹«æ‰‹ã€‚" },
      { id:"ginger_red_date_tea", name:"é»‘ç³–æ¡‚åœ“ç´…æ£—è–‘èŒ¶", category:"èŠ±è‰èŒ¶", mainType:"drink", caffeine:"none", milk:false, ginger:true, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"hot_preferred", bodySupport:["warm","nourish"], moodTag:"relax", weatherTag:"cold", vegType:"none", effectTags:["æš–èº«"], internalNote:"é»‘ç³–ï¼‹è€è–‘ï¼‹é¾çœ¼ä¹¾ï¼‹ç´…æ£—ï¼Œè¶…ç´šæš–èº«ï¼Œé©åˆèº«é«”æƒ³æš–æš–ã€æƒ³è¢«å¥½å¥½é¤Šçš„æ™‚å€™ï¼ˆå­•å©¦é¿å…ï¼‰ã€‚" },
      {
  id:"toast_margherita",
  name:"ç¾©å¼ç‘ªæ ¼éº—ç‰¹ç†±å£“åå¸",
  category:"ç†±å£“åå¸",
  mainType:"meal",
  caffeine:"none",
  milk:true,
  ginger:false,
  sugarLevel:"unsweetened",
  canMakeUnsweetened:true,
  tempOptions:"hot",
  bodySupport:["light"],
  moodTag:"relax",
  weatherTag:"mild",
  vegType:"ovo_lacto",
  effectTags:[],
  internalNote:"ç¾…å‹’ã€çƒ¤åšç•ªèŒ„èˆ‡èµ·å¸çš„ç¶“å…¸çµ„åˆï¼Œé©åˆæƒ³åƒæ¸…çˆ½ä¸€é»æˆ–è›‹å¥¶ç´ å®¢äººã€‚",

  mealSize:      "light",   // è¼•é£Ÿ
  mealFlavorTag: "fresh",   // æ¸…çˆ½
  mealBase:      "toast"    // åå¸é¡
},
{
  id:"toast_roast_chicken",
  name:"åœ°ä¸­æµ·çƒ¤é›ç†±å£“åå¸",
  category:"ç†±å£“åå¸",
  mainType:"meal",
  caffeine:"none",
  milk:true,
  ginger:false,
  sugarLevel:"unsweetened",
  canMakeUnsweetened:true,
  tempOptions:"hot",
  bodySupport:["light","nourish"],
  moodTag:"relax",
  weatherTag:"mild",
  vegType:"none",
  effectTags:[],
  internalNote:"çƒ¤é›èƒ¸ã€å½©æ¤’èˆ‡æª¸æª¬èµ·å¸ï¼Œæ²¹è„‚æ„Ÿä½ã€è›‹ç™½è³ªè¶³ï¼Œé©åˆä½œç‚ºè¼•æ­£é¤ã€‚",

  mealSize:      "light",
  mealFlavorTag: "fresh",
  mealBase:      "toast"
},
{
  id:"toast_spicy_beef",
  name:"è²»åŸè¾£çƒ¤ç‰›è‚‰ç†±å£“åå¸",
  category:"ç†±å£“åå¸",
  mainType:"meal",
  caffeine:"none",
  milk:true,
  ginger:false,
  sugarLevel:"unsweetened",
  canMakeUnsweetened:true,
  tempOptions:"hot",
  bodySupport:[],
  moodTag:"wake",
  weatherTag:"mild",
  vegType:"none",
  effectTags:[],
  internalNote:"ç‰¹è£½æ…¢çƒ¤ç‰›è‚‰ï¼‹èµ·å¸ï¼Œå‘³é“è¼ƒé‡ã€å¸¶ä¸€é»è¾£ï¼Œé©åˆå£“åŠ›å¤§æˆ–å¾ˆé¤“æ™‚ã€‚",

  mealSize:      "light",
  mealFlavorTag: "rich",   // æ¿ƒéƒ
  mealBase:      "toast"
},

{
  id:"pizza_smoked_chicken",
  name:"ç…™ç‡»é›è‚‰æŠ«è–©",
  category:"æŠ«è–©",
  mainType:"meal",
  caffeine:"none",
  milk:true,
  ginger:false,
  sugarLevel:"unsweetened",
  canMakeUnsweetened:true,
  tempOptions:"hot",
  bodySupport:[],
  moodTag:"relax",
  weatherTag:"mild",
  vegType:"none",
  effectTags:[],
  internalNote:"é›è‚‰ã€æ´‹è”¥ã€ç´…æ¤’ã€èŠ¹èœï¼Œå¸¶ç…™ç‡»é¦™æ°£ä½†ä¸æœƒéé¹¹ï¼Œè‚‰é‡èˆ‡è”¬èœå¹³è¡¡ã€‚",

  mealSize:      "full",   // é£½é£Ÿ
  mealFlavorTag: "rich",
  mealBase:      "pizza"
},
{
  id:"pizza_grilled_beef",
  name:"é¦™çƒ¤ç‰›è‚‰æŠ«è–©",
  category:"æŠ«è–©",
  mainType:"meal",
  caffeine:"none",
  milk:true,
  ginger:false,
  sugarLevel:"unsweetened",
  canMakeUnsweetened:true,
  tempOptions:"hot",
  bodySupport:[],
  moodTag:"wake",
  weatherTag:"mild",
  vegType:"none",
  effectTags:[],
  internalNote:"ç‰›è‚‰ï¼‹èµ·å¸ï¼Œç´…è‚‰èˆ‡ä¹³é…ªé¢¨å‘³åšå¯¦ï¼Œé©åˆéœ€è¦é£½è¶³æ„Ÿçš„äººã€‚",

  mealSize:      "full",
  mealFlavorTag: "rich",
  mealBase:      "pizza"
},
{
  id:"pizza_seafood_combo",
  name:"æµ·é®®ç¸½åŒ¯æŠ«è–©",
  category:"æŠ«è–©",
  mainType:"meal",
  caffeine:"none",
  milk:true,
  ginger:false,
  sugarLevel:"unsweetened",
  canMakeUnsweetened:true,
  tempOptions:"hot",
  bodySupport:["light"],
  moodTag:"relax",
  weatherTag:"mild",
  vegType:"none",
  effectTags:[],
  internalNote:"èŠ±æã€è¦ä»æ­é…è”¬èœï¼Œæµ·é®®æ„Ÿæ˜é¡¯ã€æ•´é«”åæ¸…çˆ½ã€‚",

  mealSize:      "full",
  mealFlavorTag: "fresh",
  mealBase:      "pizza"
},

{
  id:"pasta_tomato",
  name:"è•ƒèŒ„ç´…é†¬ç¾©å¤§åˆ©éºµ",
  category:"ç¾©å¤§åˆ©éºµ",
  mainType:"meal",
  caffeine:"none",
  milk:false,
  ginger:false,
  sugarLevel:"unsweetened",
  canMakeUnsweetened:true,
  tempOptions:"hot",
  bodySupport:["light"],
  moodTag:"relax",
  weatherTag:"mild",
  vegType:"none",
  effectTags:[],
  internalNote:"è•ƒèŒ„ç´…é†¬ï¼‹è‚‰èˆ‡è”¬èœï¼Œé…¸ç”œé–‹èƒƒã€é£½è¶³æ„Ÿé«˜ä½†ä¸æœƒå¤ªè†©ã€‚",

  mealSize:      "full",
  mealFlavorTag: "fresh",
  mealBase:      "pasta"
},
{
  id:"pasta_white_sauce",
  name:"åŸ¹æ ¹ç™½é†¬ç¾©å¤§åˆ©éºµ",
  category:"ç¾©å¤§åˆ©éºµ",
  mainType:"meal",
  caffeine:"none",
  milk:true,
  ginger:false,
  sugarLevel:"unsweetened",
  canMakeUnsweetened:true,
  tempOptions:"hot",
  bodySupport:["nourish"],
  moodTag:"relax",
  weatherTag:"cold",
  vegType:"none",
  effectTags:[],
  internalNote:"å¥¶æ²¹ç™½é†¬ï¼‹è±¬åŸ¹æ ¹èˆ‡è”¬èœï¼Œå¥¶å‘³æ¿ƒéƒã€åç½ªæƒ¡æ„Ÿï¼Œé©åˆæƒ³åƒé‡ä¸€é»çš„æ™‚å€™ã€‚",

  mealSize:      "full",
  mealFlavorTag: "rich",
  mealBase:      "pasta"
},


      { id:"basque_original", name:"åŸå‘³å·´æ–¯å…‹ä¹³é…ªè›‹ç³•", category:"ç”œé»", mainType:"dessert", caffeine:"none", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"ovo_lacto", effectTags:[], internalNote:"ä¹³é…ªé¦™æ¿ƒã€ç”œåº¦ä¸­ç­‰ï¼Œæ˜¯ç¬¬ä¸€æ¬¡ä¾†æœ€å®‰å…¨çš„å·´æ–¯å…‹é¸æ“‡ã€‚" },
      { id:"basque_matcha", name:"æŠ¹èŒ¶å·´æ–¯å…‹ä¹³é…ªè›‹ç³•", category:"ç”œé»", mainType:"dessert", caffeine:"low", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"ovo_lacto", effectTags:[], internalNote:"æŠ¹èŒ¶å¾®è‹¦å›ç”˜ã€ç”œåº¦ç•¥ä½ï¼Œé©åˆå–œæ­¡å¤§äººå‘³æŠ¹èŒ¶çš„äººã€‚" },
      { id:"basque_tieguanyin", name:"éµè§€éŸ³å·´æ–¯å…‹ä¹³é…ªè›‹ç³•", category:"ç”œé»", mainType:"dessert", caffeine:"low", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"mild", vegType:"ovo_lacto", effectTags:[], internalNote:"éµè§€éŸ³èŒ¶é¦™æ˜é¡¯ã€ç”œåº¦ä¸é«˜ï¼Œé©åˆä¸æ„›å¤ªè†©ã€åˆæƒ³è¦èŒ¶éŸ»çš„äººã€‚" },
      { id:"basque_chocolate", name:"å·§å…‹åŠ›å·´æ–¯å…‹ä¹³é…ªè›‹ç³•", category:"ç”œé»", mainType:"dessert", caffeine:"low", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"relax", weatherTag:"cold", vegType:"ovo_lacto", effectTags:[], internalNote:"å¯å¯æ¿ƒéƒã€è‹¦ç”œå¹³è¡¡ï¼Œé©åˆéœ€è¦é‡å£å‘³ç”œé£Ÿç™‚ç™’çš„æ™‚å€™ã€‚" },
      { id:"dessert_seasonal", name:"æœŸé–“é™å®šè›‹ç³•", category:"ç”œé»", mainType:"dessert", caffeine:"none", milk:true, ginger:false, sugarLevel:"normal", canMakeUnsweetened:false, tempOptions:"both", bodySupport:["nourish"], moodTag:"surprise", weatherTag:"mild", vegType:"ovo_lacto", effectTags:[], internalNote:"ä¾å­£ç¯€èˆ‡éˆæ„Ÿæ›´æ›å£å‘³ï¼Œé©åˆé¡˜æ„äº¤å‡ºé¸æ“‡æ¬Šã€æƒ³åšé®®çš„äººã€‚" }
    ];

/* ç¡¬éæ¿¾ï¼šç›´æ¥ä¸èƒ½æ¨è–¦çš„é …ç›®å…ˆæ’æ‰ */
function passesHardFilter(item, p) {
  const isIceSugarOrSoda =
    item.category === 'å†°ç³–èŠ±é‡€é£²' || item.category === 'æ°£æ³¡é£²';

  // è›‹å¥¶ç´ ï¼šä¸»é¤åªç•™è›‹å¥¶ç´ 
  if (p.vegetarian) {
    if (item.mainType === 'meal' && item.vegType !== 'ovo_lacto') return false;
  }

  // ä¸åƒç‰›
  if (p.noBeef && item.id && item.id.includes('beef')) return false;

  // ä¸å–é®®å¥¶é¡é£²å“ï¼šåªæ“‹ drink+milk
  if (p.avoidMilk && item.mainType === 'drink' && item.milk) return false;

  // ä¸å–å’–å•¡å› 
  if (p.noCaffeine && item.caffeine !== 'none') return false;

  // ä¸å–å†°é£²
  if (p.noIce && item.mainType === 'drink') {
    if (item.tempOptions === 'cold' || isIceSugarOrSoda) return false;
  }

  // æœˆç¶“ï¼šé¿å…å†°é£²ï¼‹æ°£æ³¡ï¼‹è–‘
  if (p.period && item.mainType === 'drink') {
    if (item.tempOptions === 'cold' || isIceSugarOrSoda) return false;
    if (item.ginger) return false;
  }

  // æ‡·å­•ï¼šé¿å…å’–å•¡å› ï¼‹è–‘ï¼‹ç‰¹å®šèŠ±è‰
  if (p.pregnant && item.mainType === 'drink') {
    if (item.caffeine !== 'none') return false;
    if (item.ginger) return false;
    const riskyHerbIds = ['peppermint', 'rose_herbal', 'strawberry_herbal', 'osmanthus'];
    if (riskyHerbIds.some(k => item.id && item.id.includes(k))) return false;
  }

  return true;
}

/* è¨ˆåˆ†é‚è¼¯ */
function scoreItem(item) {
  const { mood, bodyNeeds, prefs, weather, timeHour, purpose} = state;

  // å‘½é‹ç‰Œï¼šåªä¿ç•™ hidden_soda + é™å®šç”œé»
  if (mood === 'lucky') {
    if (!passesHardFilter(item, prefs)) return -999;
    if (item.id === 'hidden_soda' || item.id === 'dessert_seasonal') {
      return 9999 + Math.random();
    }
    return Math.random() * 50;
  }

  if (!passesHardFilter(item, prefs)) return -999;

  let score = 0;

  // é£²æ–™
  if (item.mainType === 'drink') {
    if (mood === 'focus') {
      if (item.caffeine === 'normal') score += 16;
      if (['americano','espresso','espresso_romano'].includes(item.id)) score += 6;
    }
    if (mood === 'down') {
      if (['relax','photo'].includes(item.moodTag)) score += 8;
      if (item.category === 'èŠ±è‰èŒ¶' || item.category === 'å†°ç³–èŠ±é‡€é£²') score += 6;
    }
    if (mood === 'tired') {
      if (item.bodySupport?.includes('nourish')) score += 10;
      if (item.bodySupport?.includes('warm'))   score += 8;
    }
    if (mood === 'happy') {
      if (['photo','surprise'].includes(item.moodTag)) score += 10;
      if (item.category === 'é®®å¥¶ç‰¹èª¿' || item.category === 'æ°£æ³¡é£²') score += 8;
    }
// === æ–°å¢ï¼šä»Šå¤©çš„ã€Œç›®çš„ã€åŠ æ¬Š ===
  if (purpose === 'study') {
    // é¡ä¼¼ focusï¼Œä½†ç¨å¾®ä¿å®ˆä¸€é»ï¼Œé¿å…å¤ªç¡¬ç¿»ç›¤
    if (item.caffeine === 'normal') score += 10;
    if (['americano','espresso','espresso_romano','espresso_romano'].includes(item.id)) score += 4;
    if (item.moodTag === 'wake') score += 4;
  }

  if (purpose === 'chat') {
    // è·Ÿæœ‹å‹èŠå¤©ï¼šåå¥½èˆ’æœã€å¥½å…¥å£ã€é©åˆèŠå¤©çš„
    if (['relax','photo'].includes(item.moodTag)) score += 6;
    if (item.category === 'é®®å¥¶ç‰¹èª¿' || item.category === 'æ°£æ³¡é£²' || item.category === 'ç´”èŒ¶') {
      score += 4;
    }
  }

  if (purpose === 'photo') {
    // æ…•åè€Œä¾†ï¼šå°±æ˜¯è¦å¥½æ‹
    if (item.moodTag === 'photo') score += 12;
    if (item.moodTag === 'surprise') score += 6;
    if (item.category === 'æ°£æ³¡é£²' || item.category === 'å†°ç³–èŠ±é‡€é£²') score += 4;
  }

  if (purpose === 'cat') {
    // æ“¼è²“ï¼šå¹³éœã€é™ªä¼´ã€ä¸è¦å¤ªåˆºæ¿€
    if (item.moodTag === 'relax') score += 6;
    if (item.caffeine === 'none') score += 4;
    if (item.bodySupport?.includes('warm') || item.category === 'èŠ±è‰èŒ¶') score += 4;
  }
    // === æ–°å¢ï¼šæœ‰é»å¿ƒäº‹ï¼Œæƒ³å®‰éœæ•´ç† ===
    if (purpose === 'heal') {
      // åå‘æš–èº«ã€å®‰æ’«æƒ…ç·’çš„èŠ±è‰èŒ¶æˆ–ç†±é£²
      if (item.moodTag === 'relax') score += 8;
      if (item.category === 'èŠ±è‰èŒ¶') score += 6;
      if (item.bodySupport?.includes('warm') || item.bodySupport?.includes('nourish')) {
        score += 4;
      }
      // ç›¡é‡å°‘å’–å•¡å› ï¼šç„¡å’–å•¡å› å°åŠ åˆ†ã€å¼·æç¥ç•¥æ¸›åˆ†
      if (item.caffeine === 'none') score += 3;
      if (item.effectTags?.includes('å¼·æç¥')) score -= 4;
    }

    // === æ–°å¢ï¼šæƒ³æ…¶ç¥ä¸€ä¸‹ / ç´„æœƒ ===
    if (purpose === 'celebrate') {
      // æƒ³è¦ã€Œæœ‰å„€å¼æ„Ÿã€ï¼šå¥½æ‹ã€ç‰¹èª¿ã€é©šå–œé¡
      if (['photo','surprise'].includes(item.moodTag)) score += 10;
      if (['æ°£æ³¡é£²','å†°ç³–èŠ±é‡€é£²','é®®å¥¶ç‰¹èª¿'].includes(item.category)) score += 5;
      // æœ‰æ•…äº‹æ„Ÿçš„æ•ˆæœä¹Ÿç¨å¾®åŠ åˆ†ï¼ˆä¾‹å¦‚è§£è†©ã€æš–èº«ç­‰ï¼‰
      if (item.effectTags?.includes('è§£è†©') || item.effectTags?.includes('æš–èº«')) {
        score += 2;
      }
    }

    if (bodyNeeds?.light   && item.bodySupport?.includes('light'))   score += 6;
    if (bodyNeeds?.nourish && item.bodySupport?.includes('nourish')) score += 6;
    if (bodyNeeds?.warm    && item.bodySupport?.includes('warm'))    score += 6;

    // æ™‚é–“ï¼šè¶Šæ™šè¶Šä¸æ¨é«˜å’–å•¡å› 
    if (timeHour >= 18 && item.caffeine === 'none')   score += 8;
    if (timeHour >= 20 && item.caffeine === 'normal') score -= 15;
    if (timeHour >= 22 && item.caffeine === 'normal') score -= 999;

    const isIceSugarOrSoda3 =
      item.category === 'å†°ç³–èŠ±é‡€é£²' || item.category === 'æ°£æ³¡é£²';

    // å¤©æ°£ï¼šç†±åå†·é£²ï¼Œå†·åç†±é£²
    if (weather.tag === 'hot' &&
        (item.tempOptions === 'cold' || item.weatherTag === 'hot')) {
      score += 4;
    } else if (weather.tag === 'cold' && item.tempOptions !== 'cold') {
      score += 4;
    }

    // ä¸‹é›¨å¤©ï¼šåæš–åèŒ¶
    if (state.weather.condition === 'rain') {
      if (item.bodySupport?.includes('warm') || item.category === 'èŠ±è‰èŒ¶') score += 6;
      if (item.id === 'ginger_red_date_tea' || item.id === 'ginger_longan_milk') score += 8;
      if (isIceSugarOrSoda3 && item.tempOptions === 'cold') score -= 6;
    }
  }

  // ä¸»é¤ï¼šè¼•é£Ÿ / é£½é£Ÿ ï¼‹ æ¸…çˆ½ / æ¿ƒéƒ
  else if (item.mainType === 'meal') {
    const sizePref   = state.mealSizePref;    // "light" | "full"
    const flavorPref = state.mealFlavorPref;  // "fresh" | "rich"
    const baseBias   = state.mealBaseBias || [];

    if (sizePref === 'light') {
      if (item.mealSize === 'light') score += 20;
      else score -= 5;
    } else if (sizePref === 'full') {
      if (item.mealSize === 'full') score += 20;
      else score -= 5;
    }

    if (flavorPref === 'fresh') {
      if (item.mealFlavorTag === 'fresh') score += 20;
      else score -= 5;
    } else if (flavorPref === 'rich') {
      if (item.mealFlavorTag === 'rich') score += 20;
      else score -= 5;
    }

    if (baseBias.includes(item.mealBase)) {
      score += 8;
    }
  }

  // ç”œé»ï¼šäººæ ¼åŒ¹é…
  else if (item.mainType === 'dessert') {
    const persona = state.dessertPersona;
    if (persona) {
      switch (persona) {
        case "original":
          if (item.id === "basque_original")   score += 40;
          if (item.id === "dessert_seasonal")  score -= 10;
          break;
        case "tieguanyin":
          if (item.id === "basque_tieguanyin") score += 40;
          if (item.id === "basque_matcha")     score += 10;
          break;
        case "choco":
          if (item.id === "basque_chocolate")  score += 40;
          break;
        case "matcha":
          if (item.id === "basque_matcha")     score += 40;
          if (item.id === "basque_tieguanyin") score += 10;
          break;
        case "adventure":
          if (item.id === "dessert_seasonal")  score += 40;
          if (item.id === "basque_original")   score -= 10;
          break;
      }
    }
  }

  return score + Math.random();
}

/* æŒ‘é¸æ¨è–¦çµ„åˆï¼šä¸»é¤ + å…©æ¯é£²æ–™ + ç”œé» */
function pickRecommendations() {
  const typesOrder = ['meal','drink','dessert'];
  const picks = { meal:null, drinks:[], dessert:null };

  typesOrder.forEach(type => {
    if (!state.goals.length || state.goals.includes(type)) {
      let items = MENU_ITEMS.filter(i => i.mainType === type);
      if (!items.length) return;

      // ä¸»é¤ï¼šè‹¥æœ‰ base åå¥½ï¼Œå„ªå…ˆå¾é‚£å¹¾é¡æŒ‘
      if (type === 'meal' && state.mealBaseBias && state.mealBaseBias.length) {
        const filtered = items.filter(i => state.mealBaseBias.includes(i.mealBase));
        if (filtered.length) items = filtered;
      }

      const scored = items
        .map(item => ({ item, score: scoreItem(item) }))
        .filter(x => x.score > -500)
        .sort((a,b) => b.score - a.score);

      if (!scored.length) return;

      if (type === 'drink') {
        const drinkCount = 2;
        picks.drinks = scored.slice(0, drinkCount).map(x => x.item);
      } else if (type === 'meal') {
        picks.meal = scored[0]?.item || null;
      } else if (type === 'dessert') {
        picks.dessert = scored[0]?.item || null;
      }
    }
  });

  return picks;
}
const MEAL_BASE_EMOJI = { toast:"ğŸ¥ª", pizza:"ğŸ•", pasta:"ğŸ" };
const TYPE_EMOJI = { drink:"ğŸ¥¤", dessert:"ğŸ°" };
const TYPE_LABEL = { meal:"ä¸»é¤", drink:"é£²æ–™", dessert:"ç”œé»" };

function getItemEmoji(item){
  if (item.mainType === "meal") return MEAL_BASE_EMOJI[item.mealBase] || "ğŸ½ï¸";
  return TYPE_EMOJI[item.mainType] || "âœ¨";
}

function renderComboCards(combo){
  const { meal, drinks, dessert } = combo;

  resultCardsEl.textContent = "";
  const box = document.createElement("div");
  box.className = "reco-cards";

  const addCard = (label, item) => {
    if (!item) return;

    const el = document.createElement("div");
    el.className = "reco-card";

    const title = document.createElement("div");
    title.className = "reco-card-title";
    title.textContent = `${label} Â· ${getItemEmoji(item)} ${item.name}`;

    const meta = document.createElement("div");
    meta.className = "reco-card-meta";
    meta.textContent = `${TYPE_LABEL[item.mainType] || item.mainType} Â· ${item.category || ""}`.trim();

    const note = document.createElement("div");
    note.className = "reco-card-note";
    note.textContent = item.internalNote || "";

    el.appendChild(title);
    el.appendChild(meta);
    el.appendChild(note);
    box.appendChild(el);
  };

  addCard("ä¸»é¤", meal);
  (drinks || []).forEach((d, i) => addCard(i === 0 ? "é£²æ–™1" : "é£²æ–™2", d));
  addCard("ç”œé»", dessert);

  resultCardsEl.appendChild(box);
}


/* === æ™‚æ®µæ¨™ç±¤ï¼šæ—©ä¸Š / ä¸­åˆ / ä¸‹åˆ / æ™šä¸Š === */
function getTimeLabel(h) {
  if (h >= 5 && h < 11) return "æ—©ä¸Š";
  if (h >= 11 && h < 13) return "ä¸­åˆ";
  if (h >= 13 && h < 18) return "ä¸‹åˆ";
  if (h >= 18 && h <= 23) return "æ™šä¸Š";
  return "æ·±å¤œ";
}

/* æœ¬åœ° fallbackï¼šè¬ä¸€ Gemini æ›æ‰å°±ç”¨é€™å€‹æ•˜äº‹ */
function generateComboFallback(combo) {
  const { meal, drinks, dessert } = combo;
  const { timeHour, weather, prefs } = state;

  const lines = [];

  const label = getTimeLabel(timeHour);
  const timeText = `${label}å¤§ç´„ ${timeHour.toString().padStart(2, "0")} é»`;
  lines.push(`${timeText}ï¼Œæœ¬å–µçœ‹å®Œä½ ä»Šå¤©çš„ç‹€æ…‹å¾Œï¼Œæ’å‡ºäº†é€™ä¸€çµ„ï¼š`);

  if (meal) {
    lines.push(`ä¸»é¤å…ˆä¾†ä¸€ä»½ã€Œ${meal.name}ã€ï¼Œç•¶ä½œä»Šå¤©çš„è£œ HP ä¸»åŠ›ã€‚`);
  }

  if (drinks && drinks.length) {
    const drinkNames = drinks.map(d => `ã€Œ${d.name}ã€`).join(" ï¼‹ ");
    if (weather.tag === "hot") {
      lines.push(`å–çš„éƒ¨åˆ†ï¼Œæœ¬å–µå¹«ä½ æ¹Šæˆ ${drinkNames}ï¼Œåæ¸…çˆ½ï¼Œé©åˆç¾åœ¨é€™ç¨®å¤©æ°£ã€‚`);
    } else if (weather.tag === "cold") {
      lines.push(`å–çš„éƒ¨åˆ†æ˜¯ ${drinkNames}ï¼Œåæº«æš–ç™‚ç™’ï¼Œé©åˆç¾åœ¨é€™ç¨®æ¯”è¼ƒæ¶¼çš„æ™‚é–“ã€‚`);
    } else {
      lines.push(`å–çš„éƒ¨åˆ†é¸äº† ${drinkNames}ï¼Œé™ªä½ æ…¢æ…¢åº¦éä»Šå¤©çš„è¡Œç¨‹ã€‚`);
    }
  }

  if (dessert) {
    lines.push(`æœ€å¾Œç”¨ç”œé»ã€Œ${dessert.name}ã€æ”¶å°¾ï¼Œå¹«ä»Šå¤©åŠ ä¸Šä¸€é»å„€å¼æ„Ÿã€‚`);
  }

  if (prefs.period && drinks.some(d => d.bodySupport?.includes("warm"))) {
    lines.push(`ä¹Ÿæœ‰ç‰¹åˆ¥å¹«ä½ æŒ‘ã€Œåæš–èº«ã€çš„é£²å“ï¼Œé™ªä½ æ¯”è¼ƒèˆ’æœåœ°åº¦éç”Ÿç†æœŸã€‚`);
  }

  return lines.join("\n");
}

/* æŠŠ combo + ç‹€æ…‹å£“æˆä¸€è¡Œ summaryï¼Œä¸Ÿçµ¦ Gemini ç•¶ context */
function buildContextSummary(combo) {
  const { meal, drinks, dessert } = combo;
  const g = state.goals;
  const p = state.prefs;
  const time = state.timeHour;

  const label = getTimeLabel(time);
  const timeText = `${label}${time.toString().padStart(2, "0")}é»å·¦å³`;

  const needs = [];
  if (g.includes("meal"))    needs.push("æƒ³åƒä¸€ä»½ä¸»é¤");
  if (g.includes("drink"))   needs.push("ä¸€å®šè¦æœ‰é£²æ–™");
  if (g.includes("dessert")) needs.push("æƒ³è¦ç”œé»æ”¶å°¾");

  if (p.period)      needs.push("æœˆäº‹æœŸé–“");
  if (p.pregnant)    needs.push("æ‡·å­•ä¸­");
  if (p.noIce)       needs.push("ä¸å–å†°é£²");
  if (p.avoidMilk)   needs.push("ä¸å–é®®å¥¶é¡é£²å“");
  if (p.vegetarian)  needs.push("è›‹å¥¶ç´ ");
  if (p.noBeef)      needs.push("ä¸åƒç‰›");

  const needText = needs.length ? needs.join("ã€") : "æ²’æœ‰ç‰¹åˆ¥é™åˆ¶";

  const drinkNames = drinks.length ? drinks.map(d => d.name).join("ã€") : "ï¼ˆç„¡é£²å“ï¼‰";

  return [
    state.userName || "ä»Šå¤©çš„å®¢äºº",
    timeText,
    needText,
    meal    ? meal.name    : "ï¼ˆç„¡ä¸»é¤ï¼‰",
    drinkNames,
    dessert ? dessert.name : "ï¼ˆç„¡ç”œé»ï¼‰"
  ].join("ï½œ");
}

/* ç¢ºä¿ Gemini å›å‚³çš„æ–‡å­—è£¡ï¼Œåªæœƒæåˆ°é€™æ¬¡ combo è£¡çœŸçš„æœ‰çš„å“é …åç¨± */
// âœ… æŠŠåŸæœ¬é‚£å€‹è¤‡é›œç‰ˆæœ¬æ•´æ®µæ›æ‰ï¼Œæ”¹æˆé€™å€‹
function validateAiText(aiText, combo) {
  if (!aiText || typeof aiText !== "string") return false;
  return aiText.trim().length > 10;
}


/* å‘¼å« Netlify ä¸Šçš„ gemini-combo Function æ‹¿æ•˜äº‹æ–‡æ¡ˆ */
async function getAIComboReason(combo, fallbackText) {
  const contextSummary = buildContextSummary(combo);
  const prompt = `
ä½ æ˜¯ã€ŒèŠç™‚è²“ Barã€çš„ AI è²“åº—é•·ï¼Œä¹Ÿæ˜¯ä¸€ä½å¾ˆæœƒç…§é¡§äººå¿ƒæƒ…çš„ç™‚ç™’ç³»åº—å“¡ã€‚
ä½ èªªè©±åƒåœ¨åº—è£¡è·Ÿç†Ÿå®¢èŠå¤©ï¼Œæœ‰ç•«é¢ã€æœ‰æº«åº¦ï¼ŒæœƒçœŸçš„çœ‹è¦‹å°æ–¹ç¾åœ¨çš„ç‹€æ…‹ï¼Œè€Œä¸æ˜¯åªåœ¨å”¸èœå–®ã€‚

ã€å®¢äººèˆ‡æƒ…å¢ƒæ‘˜è¦ï¼ˆè«‹å…ˆå®Œæ•´é–±è®€å†å›è¦†ï¼‰ã€‘
${contextSummary}

ä¸Šé¢çš„æƒ…å¢ƒä¸­ï¼Œå¯èƒ½æœƒå‡ºç¾åƒæ˜¯ï¼š
-ã€Œæœˆäº‹æœŸé–“ã€ã€Œè‚šå­ä¸èˆ’æœã€ã€Œä»Šå¤©ç‰¹åˆ¥ç´¯ã€
-ã€Œå‰›ä¸‹ç­ã€ã€Œå£“åŠ›å¾ˆå¤§ã€ã€Œå¿ƒæƒ…æ‚¶æ‚¶çš„ã€
-ã€Œä»Šå¤©æƒ³å®‰éœä¸€é»ã€ã€Œåªæƒ³å¥½å¥½æ”¾ç©ºã€
è«‹ä½ ä¸€å®šè¦å¾è£¡é¢æŠ“å‡º 1ï½2 å€‹é—œéµï¼Œç•¶æˆä½ å›è©±çš„æ ¸å¿ƒã€‚

ã€è«‹ä½ å¹«å¿™åšçš„äº‹æƒ…ã€‘

1.é–‹å ´å…ˆå¥½å¥½ã€Œçœ‹è¦‹å°æ–¹ã€ï¼ˆ2ï½3 å¥ï¼‰
  - ç›´æ¥é»å‡ºä»–ä»Šå¤©çš„ç‹€æ…‹ï¼Œä¾‹å¦‚ï¼š
    -ã€Œä»Šå¤©çš„ä½ ï¼Œå¥½åƒæ¯”å¹³å¸¸æ›´ç–²æ†Šä¸€é»ã€‚ã€
    -ã€Œæˆ‘æœ‰æ³¨æ„åˆ°ä½ ç¾åœ¨æ­£è™•åœ¨æœˆäº‹æœŸé–“ï¼Œèº«é«”æ‡‰è©²æ²’é‚£éº¼è¼•é¬†ã€‚ã€
  - ç”¨å…±æ„Ÿçš„èªæ°£æ‰¿æ¥ä»–çš„æ„Ÿå—ï¼Œä¾‹å¦‚ï¼š
    -ã€Œæˆ‘å®Œå…¨èƒ½ç†è§£é‚£ç¨®åˆç´¯åˆæœ‰é»ç…©èºçš„æ„Ÿè¦ºã€‚ã€
  - å†è‡ªç„¶å¸¶å‡ºï¼šå› ç‚ºé€™æ¨£ï¼Œæ‰€ä»¥æ‰å¹«ä»–æ­äº†é€™ä¸€çµ„é¤é»ã€‚

  âœ¦ åƒè€ƒèªæ°£ç¤ºä¾‹ï¼ˆä¸è¦ç›´æ¥ç…§æŠ„å­—å¥ï¼Œåªå­¸ç¿’é¢¨æ ¼ï¼‰ï¼š
  ã€Œä»Šå¤©çš„ä½ æ˜¯ä¸æ˜¯æ¯”å¹³å¸¸æ›´ç–²æ†Šï¼Ÿæˆ‘æœ‰çœ‹åˆ°ä½ ç¾åœ¨æ­£è™•åœ¨æœˆäº‹æœŸé–“ï¼Œé‚£ç¨®æ‚¶è„¹ã€ç…©èºï¼Œæˆ‘çœŸçš„å¯ä»¥æƒ³åƒã€‚æ‰€ä»¥é€™æ¬¡ç‰¹åˆ¥å¹«ä½ æŒ‘äº†æ¯”è¼ƒæº«æš–ã€å¥½å…¥å£çš„çµ„åˆï¼Œè®“ä½ å¯ä»¥ä¸€é‚Šä¼‘æ¯ã€ä¸€é‚Šæ…¢æ…¢ç…§é¡§è‡ªå·±çš„èº«é«”ã€‚ã€

2.èªªæ˜é€™ä¸€çµ„æ­é…çš„ã€Œç‚ºä»€éº¼ã€èˆ‡ã€Œæ„Ÿè¦ºã€ï¼ˆ3ï½5 å¥ï¼‰
  - æ¯å€‹è¢«æåˆ°çš„å“é …åç¨±ï¼Œéƒ½ç”¨å…¨å½¢å¼•è™Ÿæ‹¬èµ·ä¾†ï¼Œä¾‹å¦‚ï¼šã€ŒåŸå‘³å·´æ–¯å…‹ä¹³é…ªè›‹ç³•ã€ã€‚
  - èªªæ˜æ™‚è¦æŠŠå“é …ï¼Œè·Ÿä»–çš„ç‹€æ…‹é€£åœ¨ä¸€èµ·ï¼Œä¸è¦åªè¬›åŠŸèƒ½ï¼š
    -ã€Œå› ç‚ºä½ ä»Šå¤©è‚šå­æ¯”è¼ƒæ•æ„Ÿï¼Œæ‰€ä»¥é¸äº†ã€ç†±ç´…èŒ¶ã€ï¼Œè®“èº«é«”å…ˆæš–èµ·ä¾†ã€‚ã€
    -ã€Œå†é…ä¸Šä¸€å¡Šã€åŸå‘³å·´æ–¯å…‹ä¹³é…ªè›‹ç³•ã€ï¼Œå£æ„Ÿæ¯”è¼ƒæŸ”è»Ÿï¼Œä¸æœƒå¤ªåˆºæ¿€ã€‚ã€
  - å¯ä»¥å¤šç”¨æ„Ÿå—èˆ‡ç•«é¢ä¾†å½¢å®¹ï¼š
    -ã€Œåƒå¹«è‡ªå·±æŒ‰ä¸‹æš«åœéµï¼Œæ…¢æ…¢æŠŠä¸€å¤©çš„ç–²æ†Šå¸ä¸‹ä¾†ã€‚ã€
    -ã€Œè®“èº«é«”æš–ä¸€é»ã€å¿ƒä¹Ÿè·Ÿè‘—é¬†ä¸€é»ã€‚ã€

3.å°¾å·´åŠ ä¸Šä¸€é»äº’å‹•æ„Ÿï¼ˆ1ï½2 å¥ï¼‰
  - ç”¨æº«æŸ”çš„æ–¹å¼ï¼ŒæŠŠé¸æ“‡æ¬Šäº¤é‚„çµ¦å®¢äººï¼Œå¯ä»¥ç”¨è¼•é¬†çš„ç–‘å•å¥ï¼š
    -ã€Œå¦‚æœä½ ç¾åœ¨æœ€æƒ³åšçš„ï¼Œæ˜¯å…ˆæš–æš–èº«å­ï¼Œé‚£å¯ä»¥å…ˆå¾ã€ç†±ç´…èŒ¶ã€é–‹å§‹é™ªä½ æ…¢æ…¢æ”¾é¬†ã€‚ã€
    -ã€Œä½ ä¹Ÿå¯ä»¥æƒ³æƒ³ï¼Œä»Šå¤©æ¯”è¼ƒéœ€è¦çš„æ˜¯å®‰éœé™ªä¼´ï¼Œé‚„æ˜¯ä¸€é»é»å°å°çš„ç”œï¼Ÿã€
  - ä¸è¦ç”¨å‘½ä»¤æˆ–å¼·è¿«èªæ°£ï¼Œä¸è¦èªªã€Œä¸€å®šè¦é»ã€ã€Œæœ€é©åˆä½ çš„å°±æ˜¯ã€ã€‚

ã€é¢¨æ ¼èˆ‡é™åˆ¶ã€‘

4.é¢¨æ ¼è¦æ±‚
  - ä½¿ç”¨è‡ªç„¶çš„ç¹é«”ä¸­æ–‡ï¼Œåƒè·Ÿæœ‹å‹èªªè©±ï¼Œæœ‰äººå‘³ï¼Œä¸è¦åˆ¶å¼å®¢æœè…”ã€‚
  - èªæ°£å¯ä»¥æº«æŸ”ã€å¸¶ä¸€é»å¯æ„›çš„è²“åº—é•·æ„Ÿï¼Œä½†ä¸è¦è¬›å¤ªå¤šå»¢è©±ã€‚
  - å¥å­å¯ä»¥çŸ­ä¸€é»æ²’é—œä¿‚ï¼Œå¤šç”¨ç”Ÿæ´»æ„Ÿçš„å½¢å®¹è©ï¼ˆæš–æš–çš„ã€æ…¢æ…¢ä¾†ã€å®‰ç©©ä¸€é»â€¦ï¼‰ã€‚
  - å°è©±æ’ç‰ˆé †æš¢å®¹æ˜“é–±è®€ï¼Œä¸è¦æ“ æˆä¸€å¤§åœ˜

5.å“é …é™åˆ¶
  - ä¸è¦å‡ºç¾ä»»ä½•èœå–®ä¸Šæ²’æœ‰çš„å“é …åç¨±ã€‚
  - æ¯å€‹è¢«æåˆ°çš„å“é …åç¨±ï¼Œéƒ½ç”¨å…¨å½¢å¼•è™Ÿæ‹¬èµ·ä¾†ï¼Œä¾‹å¦‚ï¼šã€ŒåŸå‘³å·´æ–¯å…‹ä¹³é…ªè›‹ç³•ã€ã€‚

6.æ±ºç­–èˆ‡æ¨éŠ·
  - ä½ çš„ä»»å‹™æ˜¯ã€Œè§£é‡‹ç‚ºä»€éº¼é€™çµ„å¾ˆè²¼è¿‘ä»–ã€ï¼Œä¸æ˜¯å¹«ä»–åšæ±ºå®šã€‚
  - ä¸è¦ä½¿ç”¨å¼·çƒˆæ¨éŠ·èªæ°£ï¼Œä¸è¦ä¿è­‰ä»»ä½•æ•ˆæœï¼ˆä¾‹å¦‚ï¼šä¸€å®šæ”¹å–„ã€ä¸€å®šä¸ç—›ï¼‰ã€‚

è«‹ä¾ç…§ä»¥ä¸Šè¦å‰‡ï¼Œç”¢å‡ºä¸€æ®µå®Œæ•´çš„å›è¦†ï¼Œä¸è¦å†é‡è¤‡æ¢åˆ—è¦å‰‡ï¼Œåªå‘ˆç¾çµ¦å®¢äººçœ‹çš„æœ€çµ‚å°è©±å…§å®¹å³å¯ã€‚
`.trim();

  console.log("æº–å‚™å‘¼å« Gemini proxy");

  try {
    if (aiAbort) aiAbort.abort();
    aiAbort = new AbortController();

    const res = await fetch("https://square-base-169d-ai-cat-gemini-proxy.talktokittiesbar511.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt }),
      signal: aiAbort.signal
    });
    
    console.log("âœ… Gemini proxy ç‹€æ…‹:", res.status);

    if (!res.ok) {
      throw new Error(`API error: ${res.status}`);
    }

    const data = await res.json();
    const text = data?.text;

    if (text && typeof text === "string") {
      const cleaned = text
        .replace(/\*/g, "")
        .replace("æš«æ™‚ç„¡æ³•é€£ç·šåˆ° AI æœå‹™ï¼Œå…ˆç”¨æœ¬åœ°æ¨è–¦ä»£æ›¿å–”ï¼", "")
        .trim();
      
      console.log("ğŸ§¹ æ¸…ç†å¾Œçš„æ–‡å­—:", cleaned.slice(0, 50));
      
      // é©—è­‰ä¸¦å›å‚³
      if (validateAiText(cleaned, combo)) {
         return cleaned;
      } else {
         console.warn("âš ï¸ AI æ–‡æ¡ˆé©—è­‰æœªé€šé (å¤ªçŸ­æˆ–æ ¼å¼éŒ¯èª¤)");
      }
    } else {
      console.warn("âš ï¸ æ²’æœ‰æœ‰æ•ˆçš„ text æ¬„ä½");
    }

  } catch (e) {
    if (e?.name !== "AbortError") {
      console.error("âŒ Gemini éŒ¯èª¤:", e);
    }
  } finally {
    aiAbort = null;
  }

  console.log("ğŸ“‹ ç™¼ç”ŸéŒ¯èª¤æˆ–é©—è­‰å¤±æ•—ï¼Œæœ€çµ‚ä½¿ç”¨ fallback");
  return fallbackText;
}

// å•å®Œå…¨éƒ¨ï¼Œç”¢ç”Ÿæ¨è–¦çµæœï¼ˆä¸€æ¬¡æ€§é¡¯ç¤ºæœ€çµ‚æ–‡æ¡ˆï¼‰
async function finishQuestionFlow() {
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  // ä¸€æ¨£å…ˆèµ°ã€Œç¿»èœå–®ã€éå ´
  const waitingText =
    "å¥½ï¼Œè³‡æ–™æ”¶é›†å®Œæˆï¼Œæœ¬å–µä¾†ç¿»ä¸€ä¸‹ä»Šå¤©çš„èœå–®â€¦\n\n" +
    "ä½ å…ˆåœ¨å§å°å‰ç¨å¾®ç­‰ç­‰ï¼Œè½åˆ°å–µä¸€è²çš„æ™‚å€™ï¼Œå°±ä»£è¡¨æˆ‘æƒ³å¥½äº†ã€‚ğŸ¾";

  // ç­‰é€™æ®µæ‰“å®Œä¹‹å¾Œï¼Œå†é€²å…¥è¨ˆç®—ï¼‹Gemini æµç¨‹
  typeText(waitingText, 32, async () => {
    const combo = pickRecommendations();

    // è·Ÿæ˜¨å¤©ä¸€æ¨£ï¼šçœŸçš„æ¹Šä¸å‡ºçµ„åˆæ™‚çš„è™•ç†
    if (!combo.meal && !combo.drinks.length && !combo.dessert) {
      dialogChoicesEl.innerHTML = "";
      const text =
        "å—¯â€¦ ä¾ç…§ä½ å‰›å‰›çµ¦çš„æ¢ä»¶ï¼Œæœ¬å–µæš«æ™‚æ¹Šä¸å‡ºä¸€å€‹å¾ˆæ»¿æ„çš„çµ„åˆã€‚\n\n" +
        "è¦ä¸è¦ç¨å¾®æ”¾å¯¬ä¸€é»æ¢ä»¶ï¼Œæˆ–æ›å€‹å¿ƒæƒ…ï¼Œæˆ‘å€‘å†é‡ä¾†ä¸€æ¬¡ï¼Ÿ";
      typeText(text, 32, () => {
        dialogChoicesEl.innerHTML = "";
        addDialogButton("å¥½ï¼Œæ”¾å¯¬ä¸€é»å†è©¦è©¦", () => startQuestionFlow());
        addDialogButton("å…ˆé€™æ¨£ï¼Œæˆ‘è‡ªå·±ç¿»å¯¦é«”èœå–®å°±å¥½", () => {
          dialogChoicesEl.innerHTML = "";
          typeText(
            "æ²’å•é¡Œï¼Œæœ¬å–µå°±åœ¨å§å°é€™é‚Šï¼Œå¦‚æœä½ ç¿»åˆ°ä¸€åŠé‚„æ˜¯å¡ä½ï¼Œå†å«æˆ‘ä¸€è²å°±å¥½ã€‚",
            32
          );
        });
      });
      return;
    }

    // å…ˆç®—æœ¬åœ° fallbackï¼Œçµ¦ Gemini ç•¶å‚™ç”¨
    const fallbackStory = generateComboFallback(combo);

    // åƒæ˜¨å¤©é‚£æ¨£å…ˆæœ‰ä¸€è¡Œå“åç¸½çµ
    const { meal, drinks, dessert } = combo;
    const namesLineParts = [];
    if (meal) namesLineParts.push(`ä¸»é¤ï¼š${meal.name}`);
    if (drinks.length)
      namesLineParts.push(`é£²å“ï¼š${drinks.map(d => d.name).join("ã€")}`);
    if (dessert) namesLineParts.push(`ç”œé»ï¼š${dessert.name}`);
    const namesLine = namesLineParts.join("ï½œ");

    // ç°¡åŒ–ï¼šåªä¿ç•™å“åé‚£ä¸€è¡Œç•¶æ¨™é¡Œ
    const intro = namesLine;

    // é—œæ‰å°è©±æ¡†
    dialogChoicesEl.innerHTML = "";
    dialogBoxEl.classList.remove("visible");

    // å…ˆæŠŠçµ„åˆå¡ç‰‡ç•«å‡ºä¾†
    renderComboCards(combo);

    // å…ˆé¡¯ç¤ºã€Œintro + fallbackã€ï¼Œç„¶å¾Œæ‰“é–‹é¢æ¿ï¼‹loading é®ç½©
    resultStoryEl.textContent = intro + "\n\n" + fallbackStory;
    // âœ… é–‹å•Ÿçµæœé¢æ¿ï¼‹å¥—ç”¨å‹•ç•«ï¼†èƒŒæ™¯æ¨¡ç³Š
resultPanelEl.classList.remove("hidden");
resultPanelEl.classList.add("show");
document.querySelector(".pixel-screen").classList.add("with-result");

    resultLoadingEl.classList.remove("hidden");
    playSfx(sfxLevelUp);

    // åœ¨èƒŒæ™¯å• Geminiï¼šæˆåŠŸå°±å› Gemini æ–‡æ¡ˆï¼ŒéŒ¯èª¤å°±å› fallback
    const finalStory = await getAIComboReason(combo, fallbackStory);

    // æ‹¿åˆ°æœ€çµ‚æ–‡æ¡ˆå¾Œï¼Œé—œæ‰ loadingï¼Œæ›´æ–°æ–‡å­—
    resultLoadingEl.classList.add("hidden");
    resultStoryEl.textContent = intro + "\n\n" + finalStory;
  });
}



/* å•å·æµç¨‹ç”¨ç‹€æ…‹é‡ç½® */
function resetAiState() {
  state.goals = [];
  state.prefs = {
    vegetarian:false,
    noBeef:false,
    avoidMilk:false,
    noIce:false,
    period:false,
    pregnant:false,
    noCaffeine:false
  };

  state.mood = null;
  state.purpose = null;         // â˜… æ–°å¢
  state.bodyNeeds = { light:false, nourish:false, warm:false };

  // ä¸»é¤åå¥½
  state.mealSizePref   = null;   // "light" | "full"
  state.mealFlavorPref = null;   // "fresh" | "rich"
  state.mealBaseBias   = [];     // ["toast","pizza","pasta"]

  // ç”œé»äººæ ¼
  state.dessertPersona = null;

  // æµç¨‹ flag
  state._askedDrink   = false;
  state._askedMeal    = false;
  state._askedDessert = false;

  state.timeHour = new Date().getHours();
}

/* å•å·å…¥å£ */
function startQuestionFlow() {
  resetAiState();
  dialogLabelEl.textContent = "AIè²“åº—é•·";
  dialogChoicesEl.innerHTML = "";

  // é—œéµï¼šé‡é–‹å°è©±æ¡†ã€é—œæ‰çµæœé¢æ¿
  dialogBoxEl.classList.add("visible");
  resultPanelEl.classList.remove("show");

  const text =
    `å¥½çš„ ${state.userName || "æ—…è¡Œè€…"}ã€‚` +
    "æ¥ä¸‹ä¾†æˆ‘æœƒç”¨å¹¾å€‹ç°¡å–®çš„å°å•é¡Œï¼Œå¹«ä½ æ‰¾å‡ºä»Šå¤©æœ€é©åˆçš„ä¸€å¥—çµ„åˆã€‚";

  typeText(text, 32, () => {
    dialogChoicesEl.innerHTML = "";
    addDialogButton("å¥½ï¼Œé–‹å§‹å¹«æˆ‘é¸", askGoalStep);
  });
}


/* ä»Šå¤©è¦æ’å“ªäº›ï¼šä¸»é¤ / é£²æ–™ / ç”œé»ï¼ˆå¯è¤‡é¸ï¼‰ */
function askGoalStep() {
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  const text =
    "ä½ æœ‰æƒ³å¥½éœ€è¦æˆ‘å¹«ä½ æ¨è–¦å“ªä¸€äº›å“é …å—ï¼Ÿ\n" +
    "å¯ä»¥è¤‡é¸ï¼Œä½†è‡³å°‘è¦é¸ä¸€å€‹å–”ã€‚";

  typeText(text, 32, () => {
    dialogChoicesEl.innerHTML = "";

    const selected = new Set();
    const options = [
      {
        id: "meal",
        icon: "ğŸ›",
        title: "æœ‰é»é¤“ï¼Œæƒ³è¦è£œä¸€é»HPï¼",
        sub: "æ‰¾ä¸€ä»½æš–èƒƒçš„é£Ÿç‰©å§"
      },
      {
        id: "drink",
        icon: "ğŸ¹",
        title: "ä¸€å®šè¦å…ˆä¾†ä¸€æ¯å–çš„å•Šï¼",
        sub: "ä¾†å’–å•¡å»³æ²’æœ‰é»å€‹é£²å“æ˜¯ä¸æ˜¯å“ªè£¡æ€ªæ€ªçš„"
      },
      {
        id: "dessert",
        icon: "ğŸ°",
        title: "æ²’ç”œé»ï¼Œç™‚ç™’åº¦æœƒå°‘å¾ˆå¤š",
        sub: "é¸ä¸€ä»½æ²»ç™’æˆ‘çš„ç”œé»èƒƒï¼Œé–‹å¿ƒæ»¿åˆ†"
      }
    ];

    options.forEach(opt => {
      const btn = document.createElement("button");
      btn.className = "dialog-btn choice-card";
      btn.innerHTML =
        `<span class="goal-emoji">${opt.icon}</span>` +
        `<span class="goal-text">` +
          `<span class="goal-title">${opt.title}</span>` +
          `<span class="goal-sub">${opt.sub}</span>` +
        `</span>`;
      btn.addEventListener("click", () => {
        playSfx(sfxClick);
        if (selected.has(opt.id)) {
          selected.delete(opt.id);
          btn.classList.remove("active-goal");
        } else {
          selected.add(opt.id);
          btn.classList.add("active-goal");
        }
      });
      dialogChoicesEl.appendChild(btn);
    });

    const nextBtn = document.createElement("button");
    nextBtn.className = "dialog-btn choice-card";
    nextBtn.textContent = "é¸å¥½äº†ï¼Œä¸‹ä¸€æ­¥";
    nextBtn.addEventListener("click", () => {
      playSfx(sfxCheck);
      if (!selected.size) {
        dialogChoicesEl.innerHTML = "";
        typeText("è‡³å°‘é¸ä¸€å€‹ç›®æ¨™ï¼Œæœ¬å–µæ‰çŸ¥é“è¦å¾å“ªè£¡é–‹å§‹å¹«ä½ æƒ³ã€‚", 32, () => {
          addDialogButton("å¥½ï¼Œå†é¸ä¸€æ¬¡", askGoalStep);
        });
        return;
      }
      state.goals = Array.from(selected);
      askRestrictStep();
    });
    dialogChoicesEl.appendChild(nextBtn);
  });
}


/* èº«é«” / é£²é£Ÿé™åˆ¶ */
function askRestrictStep() {
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  const text =
    "é‚£åœ¨é–‹å§‹é…é¤ä¹‹å‰ï¼Œå…ˆè·Ÿæˆ‘èªªï¼Œèº«é«”æˆ–é£²é£Ÿä¸Šæœ‰æ²’æœ‰éœ€è¦æˆ‘ç‰¹åˆ¥æ³¨æ„çš„åœ°æ–¹å‘¢ï¼Ÿ";

  typeText(text, 32, () => {
    dialogChoicesEl.innerHTML = "";

    const hasFood  = state.goals.includes("meal") || state.goals.includes("dessert");
    const hasMeal  = state.goals.includes("meal");
    const hasDrink = state.goals.includes("drink");

    let vegNoteEl = null;

    function makePrefButton(key, icon, title, sub) {
      const btn = document.createElement("button");
      btn.className = "dialog-btn choice-card";
      if (state.prefs[key]) btn.classList.add("active-goal");
      btn.innerHTML =
        `<span class="pref-emoji">${icon}</span>` +
        `<span class="pref-text">` +
          `<span class="pref-title">${title}</span>` +
          (sub ? `<span class="pref-sub">${sub}</span>` : "") +
        `</span>`;
      btn.addEventListener("click", () => {
        playSfx(sfxClick);
        state.prefs[key] = !state.prefs[key];
        btn.classList.toggle("active-goal", state.prefs[key]);
        if (key === 'vegetarian' && vegNoteEl && hasFood) {
          vegNoteEl.style.display = state.prefs.vegetarian ? "block" : "none";
        }
      });
      dialogChoicesEl.appendChild(btn);
      return btn;   // â† ä¸€å®šè¦åŠ é€™è¡Œ
    }

    if (hasFood) {
  const vegBtn = makePrefButton(
    'vegetarian',
    "ğŸ¥¦",
    "è›‹å¥¶ç´ ",
    "ä¸»é¤ä»¥è›‹å¥¶ç´ ç‚ºä¸»ï¼Œå¹«ä½ é¿é–‹è‘·é£Ÿã€‚"
  );

  // å»ºç«‹å°æé†’ï¼Œä½ç½®æ”¾åœ¨ã€Œè›‹å¥¶ç´ ã€æŒ‰éˆ•æ­£ä¸‹æ–¹
  vegNoteEl = document.createElement("div");
  vegNoteEl.style.display    = state.prefs.vegetarian ? "block" : "none";
  vegNoteEl.style.marginTop  = "4px";
  vegNoteEl.style.marginLeft = "32px";    // è¦–è¦ºä¸Šç¨å¾®ç¸®é€²ï¼Œè®“å®ƒåƒé™„è¨»ï¼ˆå¯ä¾ç•«é¢èª¿æ•´ï¼‰
  vegNoteEl.style.fontSize   = "11px";
  vegNoteEl.style.color      = "#c04a00";
  vegNoteEl.style.lineHeight = "1.5";
  vegNoteEl.textContent =
    "å°æé†’ï¼šåº—è£¡ç›®å‰æ²’æœ‰ã€Œå…¨ç´ ã€é¤é»ï¼Œåªæœ‰è›‹å¥¶ç´ é¸é …ã€‚\n" +
    "å¦‚æœä½ æ˜¯åƒå…¨ç´ ï¼Œå»ºè­°å…ˆé»é£²æ–™å°±å¥½äº†å–”ã€‚";

  // æ’å…¥åœ¨è›‹å¥¶ç´ æŒ‰éˆ•çš„ä¸‹ä¸€å€‹ä½ç½®
  vegBtn.parentNode.insertBefore(vegNoteEl, vegBtn.nextSibling);
}

    if (hasMeal) {
      makePrefButton('noBeef',      "ğŸ®", "ä¸èƒ½åƒç‰›è‚‰", "æ—¢ç„¶æœ‰ç¦å¿Œï¼Œé‚£æˆ‘å€‘é‚„æ˜¯é¿é–‹ç‰›è‚‰è£½å“å§ã€‚");
    }
    if (hasDrink) {
      makePrefButton('noIce',       "ğŸ§Š", "ä¸æ„›å–å†°é£²", "çœ‹ä¾†æ˜¯æ³¨é‡é¤Šèº«çš„æœ‹å‹å•Šï½é‚£å°±ä¸è¦å†°çš„å§ï¼");
      makePrefButton('period',      "ğŸ©¸", "å¥½æœ‹å‹æœŸé–“", "å§¨åª½éƒ½ä¾†äº†ï¼Œæœƒç—›ç—›çš„é‚„æ˜¯å…ˆä¸è¦å§ï¼");
      makePrefButton('pregnant',    "ğŸ¤°", "å­•åª½å’ªç‹€æ…‹", "æœ‰äº›æ±è¥¿å¯èƒ½ä¸é©åˆé€™å€‹æ™‚å€™å–å–”ï¼");
      makePrefButton('avoidMilk',   "ğŸ¥›", "é®®å¥¶æˆ‘ä¸è¡Œ", "æ˜¯ä¹³ç³–ä¸è€ç—‡å•Šï¼Œè®“æˆ‘å€‘å…ˆé¿é–‹é®®å¥¶å§ã€‚");
      makePrefButton('noCaffeine',  "ğŸš«", "ä¸è¦å’–å•¡å› ", "ä»Šå¤©çš„æ”å–é‡å¤ äº†ï¼Œå†å–ä¸‹å»å°±ä¸ç”¨ç¡äº†ã€‚");
    }
    // â˜… ä½ è¦åœ¨é€™è£¡æ’å…¥ afterRestrictDone()
    // -------------------------------------------------
    function afterRestrictDone() {
      // æœ‰é¸é£²æ–™å°±å…ˆå•ã€Œä»Šå¤©çš„ç›®æ¨™ã€
      if (state.goals.includes("drink")) {
        askPurposeStep();
      } else {
        goNextQuestionStep();
      }
    }
    // -------------------------------------------------

    const noLimitBtn = document.createElement("button");
    noLimitBtn.className = "dialog-btn choice-card";
    noLimitBtn.textContent = "éƒ½å¯ä»¥ æˆ‘æ²’æœ‰ç‰¹åˆ¥éœ€æ±‚";
    noLimitBtn.addEventListener("click", () => {
      playSfx(sfxCheck);
      state.prefs = {
        vegetarian:false,
        noBeef:false,
        avoidMilk:false,
        noIce:false,
        period:false,
        pregnant:false,
        noCaffeine:false
      };
      afterRestrictDone();   // â† é€™è£¡æ”¹æˆå‘¼å« helper
    });
    dialogChoicesEl.appendChild(noLimitBtn);

    const nextBtn = document.createElement("button");
    nextBtn.className = "dialog-btn choice-card";
    nextBtn.textContent = "å¥½ï¼Œå°±ç…§é€™äº›å§ï¼";
    nextBtn.addEventListener("click", () => {
      playSfx(sfxCheck);
      afterRestrictDone();   // â† é€™è£¡ä¹Ÿæ”¹æˆå‘¼å« helper
    });
    dialogChoicesEl.appendChild(nextBtn);
  });
}


/* å•å·æµç¨‹æ§åˆ¶ï¼šdrink â†’ meal â†’ dessert */
function goNextQuestionStep() {
  if (!state._askedDrink && state.goals.includes("drink")) {
    state._askedDrink = true;
    askDrinkMoodStep();
  } else if (!state._askedMeal && state.goals.includes("meal")) {
    state._askedMeal = true;
    askMealSizeStep();
  } else if (!state._askedDessert && state.goals.includes("dessert")) {
    state._askedDessert = true;
    askDessertPersonaStep();
  } else {
    finishQuestionFlow();
  }
}

/* å…±ç”¨ï¼šåƒ mood-card é‚£ç¨®å¡ç‰‡æŒ‰éˆ• */
function createCardButton(icon, title, sub, onClick) {
  const btn = document.createElement("button");
  btn.className = "dialog-btn choice-card";
  btn.innerHTML =
    '<span class="mood-emoji">' + icon + '</span>' +
    '<span class="mood-text">' +
      '<span class="mood-title">' + title + '</span>' +
      (sub ? '<span class="mood-sub">' + sub + '</span>' : '') +
    '</span>';
  btn.addEventListener("click", () => {
    playSfx(sfxClick);
    onClick && onClick();
  });
  dialogChoicesEl.appendChild(btn);
}

// â˜… æŠŠä½ é€™æ®µ askPurposeStep è²¼åœ¨é€™è£¡
function askPurposeStep() {
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  const text =
    "é‚£ä»Šå¤©ä¾†èŠç™‚è²“ï¼Œä¸»è¦æ˜¯æƒ³åšä»€éº¼å‘¢ï¼Ÿ\n" +
    "é¸ä¸€å€‹æœ€æ¥è¿‘ä½ æ­¤åˆ»çš„ã€Œä»»å‹™æ¨¡å¼ã€ã€‚";

  typeText(text, 32, () => {
    dialogChoicesEl.innerHTML = "";

    // 1ï¼‰èªçœŸå”¸æ›¸ / å·¥ä½œæ¨¡å¼
    createCardButton(
      "ğŸ“š",
      "èªçœŸå”¸æ›¸ / å·¥ä½œæ¨¡å¼",
      "ä»Šå¤©çš„é‡é»æ˜¯è™•ç†äº‹æƒ…ï¼Œéœ€è¦é£²æ–™ç•¶å·¥ä½œå¤¥ä¼´",
      () => {
        state.purpose = "study";
        goNextQuestionStep();
      }
    );

    // 2ï¼‰è·Ÿæœ‹å‹ä¾†èŠå¤©æ”¾é¬†
    createCardButton(
      "ğŸ—£ï¸",
      "è·Ÿæœ‹å‹ä¾†èŠå¤©æ”¾é¬†",
      "é‡é»æ˜¯èŠå¤©å’Œé™ªä¼´ï¼Œé£²æ–™æ˜¯èˆ’æœçš„èƒŒæ™¯éŸ³",
      () => {
        state.purpose = "chat";
        goNextQuestionStep();
      }
    );

    // 3ï¼‰æ…•åè€Œä¾†æƒ³æ‹å¥½çœ‹çš„
    createCardButton(
      "ğŸ“¸",
      "æ…•åè€Œä¾†æƒ³æ‹å¥½çœ‹çš„",
      "æƒ³é»ä¸€æ¯è¦–è¦ºæœ‰è¨˜æ†¶é»ã€å¥½æ‹ç…§çš„é£²å“",
      () => {
        state.purpose = "photo";
        goNextQuestionStep();
      }
    );

    // 4ï¼‰å°±é †è·¯ä¾†æ“¼å€‹è²“
    createCardButton(
      "ğŸ¾",
      "å°±é †è·¯ä¾†æ“¼å€‹è²“",
      "æ²’æœ‰ç‰¹åˆ¥å®‰æ’ï¼Œåªæƒ³è¢«è²“å’Œé£²æ–™å®‰éœé™ªè‘—",
      () => {
        state.purpose = "cat";
        goNextQuestionStep();
      }
    );

    // 5ï¼‰æœ‰é»å¿ƒäº‹ï¼Œæƒ³å®‰éœæ•´ç†
    createCardButton(
      "ğŸ•¯ï¸",
      "æœ‰é»å¿ƒäº‹ï¼Œæƒ³å®‰éœæ•´ç†",
      "éœ€è¦ä¸€æ¯å¯ä»¥æ…¢æ…¢å–ã€é™ªä½ æ•´ç†å¿ƒæƒ…çš„",
      () => {
        state.purpose = "heal";
        goNextQuestionStep();
      }
    );

    // 6ï¼‰æƒ³æ…¶ç¥ä¸€ä¸‹ / ç´„æœƒ
    createCardButton(
      "ğŸ‰",
      "æƒ³æ…¶ç¥ä¸€ä¸‹ / ç´„æœƒ",
      "ä»Šå¤©æƒ³ä¾†é»å„€å¼æ„Ÿï¼Œé£²æ–™è¦æœ‰é»å­˜åœ¨æ„Ÿ",
      () => {
        state.purpose = "celebrate";
        goNextQuestionStep();
      }
    );
  });
}


/* é£²æ–™ï¼šå¿ƒæƒ…å¡ç‰‡ */
function askDrinkMoodStep() {
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  const text =
    "é‚£åœ¨å¹«ä½ æƒ³é£²æ–™ä¹‹å‰ï¼Œå…ˆæŠ“ä¸€ä¸‹ä½ ä»Šå¤©æ•´é«”çš„ç‹€æ…‹ï½\n" +
    "ç›´è¦ºé¸ä¸€å€‹æœ€åƒç¾åœ¨çš„ä½ å°±å¥½ã€‚";

  typeText(text, 32, () => {
    dialogChoicesEl.innerHTML = "";

  // è…¦è¢‹æœ‰é»éˆï¼Œéœ€è¦æ¸…é†’
    createCardButton(
      "ğŸ§ ",
      "è…¦è¢‹æœ‰é»éˆï¼Œæƒ³æ¸…é†’ä¸€é»",
      "éœ€è¦å°ˆæ³¨ä¸€ä¸‹å·¥ä½œæˆ–è®€æ›¸ï¼Œç”¨é£²æ–™å¹«å¿™é†’è…¦",
      () => {
        state.mood = "focus";
        goNextQuestionStep();
      }
    );

    // å¿ƒæƒ…æ‚¶
    createCardButton(
      "ğŸŒ§ï¸",
      "å¿ƒæœ‰é»æ‚¶ï¼Œæä¸èµ·å‹",
      "æƒ³è¢«ä¸€æ¯æº«æŸ”çš„é£²æ–™å®‰æ…°ä¸€ä¸‹",
      () => {
        state.mood = "down";
        goNextQuestionStep();
      }
    );

    // å¾ˆç´¯
    createCardButton(
      "ğŸ”‹",
      "èº«é«”æœ‰é»ç´¯ï¼Œé›»é‡åä½",
      "éœ€è¦å¥½å¥½å……é›»ï¼ŒæŠŠè‡ªå·±è£œå›ä¾†",
      () => {
        state.mood = "tired";
        goNextQuestionStep();
      }
    );

    // ä»Šå¤©é‚„ä¸éŒ¯ã€å¿ƒæƒ…è¼•é¬†ï¼ˆä½†ä¸èªªæ…¶ç¥ï¼‰
    createCardButton(
      "ğŸŒ¤ï¸",
      "ä»Šå¤©æ•´é«”é‚„ä¸éŒ¯ï¼Œå¿ƒæƒ…è¼•é¬†",
      "æƒ³æ‰¾ä¸€æ¯é™ªä½ æŠŠå¥½ç‹€æ…‹å»¶çºŒä¸‹å»çš„é£²æ–™",
      () => {
        state.mood = "happy";
        goNextQuestionStep();
      }
    );

    // æ™®æ™®é€šé€š
    createCardButton(
      "ğŸ˜¶",
      "å°±å¾ˆæ—¥å¸¸çš„ä¸€å¤©",
      "æ²’æœ‰ç‰¹åˆ¥æƒ…ç·’ï¼Œåªæƒ³å®‰éœå–ä¸€æ¯é™ªè‡ªå·±",
      () => {
        state.mood = "neutral";
        goNextQuestionStep();
      }
    );

    // äº¤çµ¦å‘½é‹
    createCardButton(
      "ğŸ²",
      "æƒ³äº¤çµ¦å‘½é‹æ±ºå®šçœ‹çœ‹",
      "ä»Šå¤©å°±è®“è²“åº—é•·å¹«ä½ æŠ½ä¸€å€‹ç‰Œ",
      () => {
        state.mood = "lucky";
        goNextQuestionStep();
      }
    );
  });
}

/* ä¸»é¤ï¼šè¼•é£Ÿ or é£½é£Ÿ */
function askMealSizeStep() {
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  const text =
    "é‚£ä¸»é¤éƒ¨åˆ†ï¼Œä»Šå¤©æ¯”è¼ƒæƒ³è¦ã€Œå…ˆå¢Šå€‹è‚šå­ã€é‚„æ˜¯ã€Œæ…¢æ…¢åœ°åƒé£½ä¸€é»ã€å‘¢ï¼Ÿ";

  typeText(text, 32, () => {
    dialogChoicesEl.innerHTML = "";

    createCardButton("ğŸ¥ª", "æƒ³åƒè¼•é£Ÿå°±å¥½", "å¥½åƒæ²’æœ‰é€™éº¼é¤“ï¼Œç°¡å–®å°±å¥½", () => {
      state.mealSizePref = "light";
      askMealFlavorStep();  // <--- æ”¹æˆå»å•å£å‘³
    });
    createCardButton("ğŸ", "æƒ³æ…¢æ…¢åœ°ä¾†åƒé “é£¯å§", "ä»Šå¤©é€™ä¸€é¤å°±æ˜¯é‡é»ï¼Œæˆ‘æƒ³è¦åƒé£½", () => {
      state.mealSizePref = "full";
      askMealFlavorStep();  // <--- æ”¹æˆå»å•å£å‘³
    });
  });
}

/* ä¸»é¤ï¼šæ¸…çˆ½ or æ¿ƒéƒ */
function askMealFlavorStep() {
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  const text =
    "å£å‘³ä¸Šï¼Œä»Šå¤©æ¯”è¼ƒæƒ³åƒã€Œæ¸…çˆ½ä¸€é»ã€é‚„æ˜¯ã€Œæ¿ƒéƒã€é‡å£å‘³ä¸€é»ã€ï¼Ÿ";

  typeText(text, 32, () => {
    dialogChoicesEl.innerHTML = "";

    createCardButton(
      "ğŸŒ¿",
      "æ¸…çˆ½ä¸€é»çš„",
      "è•ƒèŒ„ã€æµ·é®®ï¼Œæ•´é«”åçˆ½å£ä¸€é»çš„æ–™ç†",
      () => {
        state.mealFlavorPref = "fresh";
        goNextQuestionStep();          // é¸å®Œå¾€ä¸‹ä¸€é¡Œ
      }
    );

    createCardButton(
      "ğŸ–",
      "æ¿ƒéƒã€æœ‰ç½ªæƒ¡æ„Ÿçš„",
      "èµ·å¸ã€å¥¶æ²¹ã€è‚‰æ„Ÿæ¯”è¼ƒé‡çš„æ–™ç†",
      () => {
        state.mealFlavorPref = "rich";
        goNextQuestionStep();          // é¸å®Œå¾€ä¸‹ä¸€é¡Œ
      }
    );
  });
}



/* ç”œé»äººæ ¼ï¼š5 å¼µå·´æ–¯å…‹äººæ ¼å¡ */
function askDessertPersonaStep() {
  dialogChoicesEl.innerHTML = "";
  dialogLabelEl.textContent = "AIè²“åº—é•·";

  const text =
    "æœ€å¾Œï¼Œç”œé»é€™é‚Šï¼Œæœ¬å–µæƒ³ç”¨ä¸€å€‹å°å°çš„ã€Œç”œé»äººæ ¼æ¸¬é©—ã€ä¾†å¹«ä½ æŒ‘ä¸€å¡Šã€‚\n\n" +
    "ä»¥ä¸‹å¹¾ç¨®ç‹€æ…‹ï¼Œä½ æ¯”è¼ƒåƒå“ªä¸€ç¨®ï¼Ÿç›´è¦ºé¸ä¸€å€‹å°±å¥½ã€‚";

  typeText(text, 32, () => {
    dialogChoicesEl.innerHTML = "";

    // === 5 å¼µäººæ ¼å¡ ===
    createCardButton(
      "ğŸ§±",
      "ç©©å®šæ´¾ãƒ»ç°¡å–®å°±å¥½",
      "å–œæ­¡ç©©å®šã€ä¸å–œæ­¡å¤ªå¤šé©šå–œèˆ‡è®ŠåŒ–",
      () => {
        state.dessertPersona = "original";
        goNextQuestionStep();      // â† ç”¨æ–°ç‰ˆæµç¨‹æ§åˆ¶ï¼Œä¸ç›´æ¥çµæŸ
      }
    );

    createCardButton(
      "ğŸµ",
      "å‚³çµ±æ´¾ãƒ»é‡è¦–æ–‡åŒ–",
      "å–œæ­¡èŒ¶éŸ»ã€å‚³çµ±æ„Ÿï¼Œäº«å—æ…¢æ…¢å“çš„æ°£æ°›",
      () => {
        state.dessertPersona = "tieguanyin";
        goNextQuestionStep();
      }
    );

    createCardButton(
      "ğŸ«",
      "ç™‚ç™’æ´¾ãƒ»éœ€è¦è¢«ç”œç”œåŒ…åœ",
      "æƒ³è¦ä¸€å£ä¸‹å»å°±è¢«ç”œåº¦å¥½å¥½æŠ±ä¸€ä¸‹ï¼Œé‡å£ä¸€é»ä¹Ÿå¯ä»¥",
      () => {
        state.dessertPersona = "choco";
        goNextQuestionStep();
      }
    );

    createCardButton(
      "ğŸƒ",
      "å¤§äººå‘³ãƒ»æ—¥å¼é¢¨æƒ…",
      "å¸¶ä¸€é»è‹¦ã€ã€Œå•Šæ˜¯æˆç†Ÿå¤§äººçš„æ„Ÿè¦ºå§ï¼ã€é‚£ç¨® vibe",
      () => {
        state.dessertPersona = "matcha";
        goNextQuestionStep();
      }
    );

    createCardButton(
      "ğŸ²",
      "å†’éšªæ´¾ãƒ»æƒ³ç©ç©å‘½é‹ç‰Œ",
      "é¡˜æ„äº¤å‡ºé¸æ“‡æ¬Šã€æƒ³è©¦è©¦æœŸé–“é™å®šèˆ‡é©šå–œ",
      () => {
        state.dessertPersona = "adventure";
        goNextQuestionStep();
      }
    );
  });
}


</script>

</body>
</html>
